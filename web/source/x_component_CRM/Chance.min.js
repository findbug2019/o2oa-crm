MWF.xApplication.CRM=MWF.xApplication.CRM||{},MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("CRM","Template",null,!1),MWF.xApplication.CRM.Chance=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,n){this.setOptions(n),this.path="/x_component_CRM/$Chance/",this.cssPath="/x_component_CRM/$Chance/"+this.options.style+"/css.wcss",this.lpPath="/x_component_CRM/$Chance/"+this.options.style+"/zh-cn.js?v="+o2.version.v,this._loadCss(),this.app=e,this.container=$(t),this.lp={},this.lp.head||(console.log("this.lp:::",this.lpPath),this.loadLP(),this.lp=MWF.xApplication.CRM.Chance.LP.chance),console.log("this is Chance init()"),this.actions=i},loadLP:function(){MWF.xDesktop.requireApp("CRM","$Chance.default.nzh-cn",null,!1)},load:function(){this.formContentArr&&this.formContentArr.empty(),this.formContentArr=[],this.formMarkArr&&this.formMarkArr.empty(),this.formMarkArr=[],this.rightContentDiv=this.app.rightContentDiv,this.createHeadContent(),this.createToolBarContent(),this.createChanceContent(),this.resizeWindow(),this.app.addEvent("resize",function(){this.resizeWindow()}.bind(this))},reload:function(){this.createChanceContent(),this.resizeWindow()},createHeadContent:function(){this.headContentDiv&&this.headContentDiv.destroy(),console.log(this.css),this.headContentDiv=new Element("div.headContentDiv",{styles:this.css.headContentDiv}).inject(this.rightContentDiv),this.headTitleDiv=new Element("div.headTitleDiv",{styles:this.css.headTitleDiv,text:this.lp.head.headTitle}).inject(this.headContentDiv),console.log("111111"),this.headSearchDiv=new Element("div.headSearchDiv",{styles:this.css.headSearchDiv}).inject(this.headContentDiv),this.headSearchTextDiv=new Element("div.headSearchTextDiv",{styles:this.css.headSearchTextDiv}).inject(this.headSearchDiv),this.headSearchInput=new Element("input.headSearchInput",{styles:this.css.headSearchInput,placeholder:this.lp.head.searchText}).inject(this.headSearchTextDiv),this.headSearchInput.addEvents({keyup:function(){""!=this.headSearchInput.get("value")&&this.headSearchRemoveImg.setStyles({display:"inline-block"})}.bind(this)}),this.headSearchRemoveImg=new Element("img.headSearchRemoveImg",{styles:this.css.headSearchRemoveImg,src:this.path+"default/icons/remove.png"}).inject(this.headSearchTextDiv),this.headSearchRemoveImg.addEvents({click:function(){this.headSearchInput.set("value",""),this.headSearchRemoveImg.setStyles({display:"none"})}.bind(this)}),this.headSearchButtonDiv=new Element("div.headSearchBottonDiv",{styles:this.css.headSearchButtonDiv}).inject(this.headSearchDiv),this.headSearchheadSearchButton=new Element("button.headSearchButton",{styles:this.css.headSearchButton}).inject(this.headSearchButtonDiv),this.headSearchImg=new Element("img.headSearchImg",{styles:this.css.headSearchImg,src:this.path+"default/icons/search.png"}).inject(this.headSearchheadSearchButton),this.headButtonDiv=new Element("div.headButtonDiv",{styles:this.css.headButtonDiv}).inject(this.headContentDiv),this.headNewButtonDiv=new Element("div.headNewButtonDiv",{styles:this.css.headNewButtonDiv,text:this.lp.head.create}).inject(this.headButtonDiv),this.headNewButtonDiv.addEvents({click:function(){MWF.xDesktop.requireApp("CRM","ChanceEdit",function(){console.log("this.lp",this.lp);var t=new MWF.xApplication.CRM.ChanceEdit(null,{},null,{app:this.app,container:this.app.content,lp:this.lp,actions:this.actions,css:{},callback:function(){t.create()}});t.create()}.bind(this))}.bind(this)})},createToolBarContent:function(){},createChanceContent:function(){this.contentListDiv&&this.contentListDiv.destroy(),this.contentListDiv=new Element("div.contentListDiv",{styles:this.css.contentListDiv}).inject(this.rightContentDiv),this.contentListInDiv&&this.contentListInDiv.destroy(),this.contentListInDiv=new Element("div.contentListInDiv",{styles:this.css.contentListInDiv}).inject(this.contentListDiv);var t=this.rightContentDiv.getSize();this.contentListDiv&&this.contentListDiv.setStyles({height:t.y-this.headContentDiv.getHeight()-8+"px",width:t.x+"px"}),this.contentListInDiv&&this.contentListInDiv.setStyles({height:this.contentListDiv.getHeight()+"px",width:this.contentListDiv.getWidth()+"px"}),this.chanceView&&delete this.chanceView;var e=this.path+"chanceView.json";this.chanceView=new MWF.xApplication.CRM.Chance.View(this.contentListInDiv,{},this.app,this,{templateUrl:e,filterData:{}},{isAdmin:this.options.isAdmin}),this.chanceView.load()},resizeWindow:function(){var t=this.rightContentDiv.getSize(),e=this.headTitleDiv.getSize(),i=this.headButtonDiv.getSize();if(this.headSearchDiv){var n=this.headSearchDiv.getSize().x;this.headSearchDiv.setStyles({"margin-left":(t.x-e.x-i.x)/2-n/2+"px"})}this.contentListDiv&&this.contentListDiv.setStyles({height:t.y-this.headContentDiv.getHeight()-8+"px",width:t.x+"px"}),this.contentListInDiv&&this.contentListInDiv.setStyles({height:this.contentListDiv.getHeight()+"px",width:this.contentListDiv.getWidth()+"px"})}}),MWF.xApplication.CRM.Chance.View=new Class({Extends:MWF.xApplication.CRM.Template.ComplexView,initialize:function(t,e,i,n,s,a){this.container=t,this.data=e||{},this.explorer=n,a?(this.app=i||a.app||this.explorer.app,this.lp=a.lp||this.explorer.lp||this.app.lp,this.css=a.css||this.explorer.css||this.app.css,this.actions=a.actions||this.explorer.actions||this.app.actions||this.app.restActions,this.isAdmin=a.isAdmin):(this.app=i||this.explorer.app,this.lp=this.explorer.lp||this.app.lp,this.css=this.explorer.css||this.app.css,this.actions=this.explorer.actions||this.app.actions||this.app.restActions),s.templateUrl?-1==s.templateUrl.indexOf("/")&&(s.templateUrl=this.explorer.path+s.templateUrl):s.templateUrl=this.explorer.path+"listItem.json",this.setOptions(s)},_createDocument:function(t){return new MWF.xApplication.CRM.Chance.Document(this.viewNode,t,this.explorer,this)},ayalyseTemplate:function(){MWF.getJSON(this.options.templateUrl,function(t){this.template=t,console.log("this is template,",t)}.bind(this),!1)},_getCurrentPageData:function(e,t,i,n,s){this.category=this.options.category;t||(t=10),i||(i=1);this.items.length&&this.items[this.items.length-1].data.id;var a=this.options.filterData;a={key:n?n.trim():"",orderFieldName:"updateTime",orderType:"desc"},s||(s="全部商机"),this.isAdmin&&"全部商机"==s?this.actions.getChanceByPage(i,t,a,function(t){e&&e(t)}.bind(this)):("我负责的商机"==s&&this.actions.ListMyDuty_chance(i,t,a,function(t){e&&e(t)}.bind(this)),"下属负责的商机"==s&&this.actions.ListNestedSubPerson_chance(i,t,a,function(t){e&&e(t)}.bind(this)),"我参与的商机"==s&&this.actions.ListMyParticipate_chance(i,t,a,function(t){e&&e(t)}.bind(this)),"全部商机"==s&&this.actions.ListAllMy_chance(i,t,a,function(t){e&&e(t)}.bind(this)))},useTablePlugins:function(a,t,e){console.log("this is useTablePlugins  page:"+a+";;;;text:"+t),0<jQuery(".laytable-box").length&&jQuery(".laytable-box").remove();var h,o,c,r=this,l=[],i=this.template;o=i.sortField,c=i.sortType;var n=this.container.getSize(),s=this.headTableNode.getSize(),p=n.y-s.y-80;a||(a=1),h=i.field,this._getCurrentPageData(function(s){s.data.each(function(t){if(t.owneruser){var e=t.owneruser,i=t.createuser;t.owneruser=e.split("@")[0],t.createuser=i.split("@")[0]}else t.owneruser="",t.createuser="";l.push(t)}.bind(this)),l=s.data,layui.config({base:"/x_component_CRM/$Template/plugins/table2/"}).use(["table2","table2"],function(){var t=layui.table2;console.log(h);t.render({elem:"#contentTable",data:l,height:p,width:"100%",page:{align:"right",groups:5,curr:1,count:s.count,limit:10,limits:[10,20,30,40,50,60,70,80,90]},initSort:{sortField:o,sortType:c},cols:[h]});r.container.getElements(".chanceId").forEach(function(t,e){t.addEvent("click",function(){console.log(this),r._openDocument(this.get("id"),this.text)}.bind(t))}),r.container.getElements(".customerId").forEach(function(t,e){t.addEvent("click",function(){console.log(this),r._openCustomer(this.get("id"),this.text)}.bind(t))}),jQuery(".laytable-page-pagination").find("a").each(function(t,n){jQuery(n).on("click",function(){var t=1;if(t="-1"==jQuery(n).attr("value")||"+1"==jQuery(n).attr("value")?parseInt(jQuery(n).attr("value"))+t:parseInt(jQuery(n).text()),"page-item page-last rayui-disabled"!=jQuery(n).attr("class")&&"page-item page-prev rayui-disabled"!=jQuery(n).attr("class")){var e=jQuery(".headSearchInput").val(),i="";0<jQuery(".headTableNode").find(".se-select-name").length&&(i=jQuery(".headTableNode").find(".se-select-name").text()),""!=e?r.useTablePlugins(t,e,i):r.useTablePlugins(t,"",i)}})}),jQuery(".laytable-page-btnok").on("click",function(){var t=parseInt(jQuery(".laytable-page-input").val()),e=jQuery(".headSearchInput").val(),i="";0<jQuery(".headTableNode").find(".se-select-name").length&&(i=jQuery(".headTableNode").find(".se-select-name").text()),""!=e?r.useTablePlugins(t,e,i):r.useTablePlugins(t,"",i)}),jQuery(".page-item").each(function(t,e){jQuery(e).attr("value")==a+""?jQuery(e).attr("class","page-item page-active"):"-1"!=jQuery(e).attr("value")&&"+1"!=jQuery(e).attr("value")&&jQuery(e).attr("class","page-item")});var e=jQuery(".page-active").attr("value"),i=jQuery(".page-prev").parent().next().find("a")[0],n=jQuery(".page-last").parent().prev().find("a")[0];parseInt(e)>parseInt(jQuery(i).attr("value"))?jQuery(".page-prev").attr("class","page-item page-prev"):jQuery(".page-prev").attr("class","page-item page-prev rayui-disabled"),parseInt(e)==parseInt(jQuery(n).attr("value"))?jQuery(".page-last").attr("class","page-item page-last rayui-disabled"):jQuery(".page-last").attr("class","page-item page-last"),jQuery(".laytable-page-input").attr("value",a+"")})}.bind(this),15,a,t,e)},_openDocument:function(t,e){MWF.xDesktop.requireApp("CRM","ChanceOpen",function(){this.explorer=new MWF.xApplication.CRM.ChanceOpen(this,this.actions,{},{openId:t,openName:e,openType:"single",lp:this.lp,onReloadView:function(){this.reload()}.bind(this)}),this.explorer.load()}.bind(this))},_openCustomer:function(t,e){MWF.xDesktop.requireApp("CRM","CustomerOpen",function(){this.explorer=new MWF.xApplication.CRM.CustomerOpen(this,this.actions,{},{openId:t,openName:e,openType:"single",onReloadView:function(){this.reload()}.bind(this)}),this.explorer.load()}.bind(this))}}),MWF.xApplication.CRM.Chance.Document=new Class({Extends:MWF.xApplication.CRM.Template.ComplexDocument,viewActionReturn:function(){return!1}});