MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xApplication.CRM.ChanceEdit=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"600",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,maxAction:!0,closeAction:!0,isFull:!1,startTime:null,endTime:null,isWholeday:!1,title:"新建商机",defaultCalendarId:""},load:function(){this.lp=this.lp.chanceEdit||{},this.cssPath="/x_component_CRM/$ChanceEdit/"+this.options.style+"/css.wcss",this.path="/x_component_CRM/$ChanceEdit/",this.type={},this._loadCss(),this.loadData()},create:function(){this.fireEvent("queryCreate"),this.isNew=!0,this.loadResource(function(){this._open()}.bind(this)),this.fireEvent("postCreate")},edit:function(){this.fireEvent("queryCreate"),this.isEdited=!0,this.loadResource(function(){this._open()}.bind(this)),this.fireEvent("postCreate")},loadData:function(){if(this.Customer=this.data&&this.data.customer?this.data.customer:{},!this.types&&(this.actions.getTypes(function(t){this.types=t.data}.bind(this)),this.types&&this.types.length))for(i=0;i<this.types.length;i++)this.actions.getStatusByTypeid(this.types[i].id,function(t){this.types[i].statusid=t.data,t.data.forEach(function(t,e){this.data.statusid==t.id&&(this.statusid=t)}.bind(this))}.bind(this)),this.data.typeid==this.types[i].id&&(this.type=this.types[i])},loadResource:function(t){t()},_createTableContent:function(){this.formTableArea.set("html",this.getHtml()),this.formTableArea.getElements(".conent-value").forEach(function(t,e){var i=t.getChildren()[0],s=i.getAttribute("stype"),n=i.getAttribute("id");if("datetime"==s&&(this.isNew||this.isEdited)&&this.loadTimeContainer(i),"typeid"==n&&(this.isNew||this.isEdited)){var a=this,o=this.types;if(0<o.length){for(var r='<ul class="el-dropdown-type" style="display: none;" tid="'+n+'">',l=0;l<o.length;l++)r=r+'<li class="el-dropdown-menu__item" index="'+l+'">'+o[l].opportunitytypename+"</li>";jQuery(a.formTableArea).append(r+'<div class="popper__arrow"></div></ul>'),jQuery(i).click(function(){jQuery(a.formTableArea.getElement("[tid="+n+"]")).css({left:jQuery(i).offset().left,top:jQuery(i).offset().top+30}),jQuery(a.formTableArea.getElement("[tid="+n+"]")).toggle(100)}.bind(this)),jQuery(a.formTableArea.getElement("[tid="+n+"]")).children().click(function(){jQuery(i).text(jQuery(this).text()),jQuery(a.formTableArea.getElement("[tid="+n+"]")).toggle(100);var t=a.types[jQuery(this).attr("index")];a.type&&t.id==a.type.id||(a.type=t,a.statusid={},a.changeType())})}}else"statusid"==n&&(this.isNew||this.isEdited)?(this.changeType=function(){var e=this.formTableArea.getElement("#statusid"),i=this,t=this.type.statusid;if(jQuery("[tid=statusid]").remove(),i.statusid&&i.statusid.id||jQuery(e).text(""),t&&0<t.length){for(var s='<ul class="el-dropdown-type" style="display: none;" tid="statusid">',a=0;a<t.length;a++)s=s+'<li class="el-dropdown-menu__item" index="'+a+'">'+t[a].opportunitystatusname+"</li>";jQuery(i.formTableArea).append(s+'<div class="popper__arrow"></div></ul>'),jQuery(e).unbind().click(function(){jQuery(i.formTableArea.getElement("[tid="+n+"]")).css({left:jQuery(e).offset().left,top:jQuery(e).offset().top+30}),jQuery(i.formTableArea.getElement("[tid="+n+"]")).toggle(100)}),jQuery(i.formTableArea.getElement("[tid="+n+"]")).children().click(function(){var t=i.type.statusid[jQuery(this).attr("index")];i.statusid=t,jQuery(e).text(jQuery(this).text()),jQuery(i.formTableArea.getElement("[tid="+n+"]")).toggle(100)})}}.bind(this),this.changeType()):"customer"==n&&(this.isNew||this.isEdited)&&(i.setAttribute("readOnly","true"),jQuery(i).click(function(){this.selectCustomer=new MWF.xApplication.CRM.ChanceEdit.selectForm(null,{},null,{app:this,container:this.formTableArea,lp:this.lp,actions:this.actions,css:{}}),this.selectCustomer.create()}.bind(this)))}.bind(this))},getHtml:function(){var t=this.getItemTemplate(this.lp),e='<div class="section-conent">';for(i in t){var s=t[i].type,a='<input type="text" class="inline-input" '+(this.isEdited||this.isNew?"":"readOnly")+' value="'+t[i].value+'"  name="'+i+'" id="'+i+'" stype="'+s+'">';"textarea"==s&&(a='<textarea rows="6" class="el-textarea__inner"  '+(this.isEdited||this.isNew?"":"readOnly")+' id="'+i+'" stype="'+s+'"  style="resize: none; min-height: 30.6px;">'+t[i].value+"</textarea>"),"select"==s&&(a='<div class="inline-input" style="display: inline-block;cursor:pointer;" '+(this.isEdited||this.isNew?"":"readOnly")+' id="'+i+'" stype="'+s+'" >'+t[i].value+'</div><div class="el-icon-arrow-down el-icon--right" style="margin-left: -20px; display: inline-block;"><img src="/x_component_CRM/$ChanceEdit/default/icons/arrow.png"></div>'),e=e+'<div class="conent-inline"><div class="conent-title" lable="'+i+'">'+t[i].text+'</div><div class="conent-value">'+a+"</div></div>"}return'<div class="section-header"><div class="section-mark" style="border-left-color: rgb(70, 205, 207);"></div> <div data-v-ec8f8850="" class="section-title">基本信息</div></div>'+(e+="</div>")},loadTimeContainer:function(t){jQuery(t).ymdateplugin({showTimePanel:!0})},getItemTemplate:function(t){return _self=this,{name:{text:t.name,type:"text",notEmpty:!0,value:this.data&&this.data.opportunityname?this.data.opportunityname:""},customer:{type:"text",text:t.customer,value:this.data&&this.data.customer&&this.data.customer.customername?this.data.customer.customername:""},typeid:{type:"select",text:t.typeid,value:this.data&&this.data.opportunityType&&this.data.opportunityType.opportunitytypename?this.data.opportunityType.opportunitytypename:""},statusid:{type:"select",text:t.statusid,value:this.data&&this.data.opportunityStatus&&this.data.opportunityStatus.opportunitystatusname?this.data.opportunityStatus.opportunitystatusname:""},money:{type:"text",text:t.money,value:this.data&&this.data.money?this.data.money:""},dealdate:{text:t.dealdate,name:"dealdate",attr:{id:"dealdate"},type:"datetime",value:this.data&&this.data.dealdate?this.data.dealdate:""},remark:{text:t.remark,name:"remark",type:"textarea",value:this.data&&this.data.remark?this.data.remark:""}}},ok:function(){this.fireEvent("queryOk");var t=this.getResult();t&&this._ok(t,function(t){"error"==t.type?this.app&&this.app.notice&&this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode&&this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice&&this.app.notice(this.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postOk"))}.bind(this))},getResult:function(){var e={},i={};e.type="success";try{i.opportunityname=this.formTableArea.getElement("#name").get("value"),i.customerid=this.Customer.id,i.typeid=this.type.id,i.statusid=this.statusid.id,i.money=this.formTableArea.getElement("#money").get("value"),i.dealdate=this.formTableArea.getElement("#dealdate").get("value"),i.remark=this.formTableArea.getElement("#remark").get("value"),this.isEdited&&(i.id=this.data.id)}catch(t){e.type="error",(i={}).reson=t}return e.data=i,e},_ok:function(t,e){(t.type="success")&&(this.isNew?this.actions.createChance(t.data,function(t){e(t)}):this.actions.updateChance(t.id,t.data,function(t){e(t)}))}}),MWF.xApplication.CRM.ChanceEdit.selectForm=new Class({Extends:MPopupForm,options:{style:"default",width:"700",height:"400",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,maxAction:!0,closeAction:!0,isFull:!1,startTime:null,endTime:null,isWholeday:!1,title:"选择客户",defaultCalendarId:"",callback:function(){}.bind(this)},load:function(){this.cssPath="/x_component_CRM/$ChanceEdit/"+this.options.style+"/css.wcss",this.path="/x_component_CRM/$ChanceEdit/",this.type={},this._loadCss(),this.loadData()},_createTableContent:function(){var t=this.path+"customerSelect.json";this.form=new MWF.xApplication.CRM.ChanceEdit.SelectCustomer(this.formTableArea,null,this.app,this,{templateUrl:t,filterData:{},listPageName:"getCustomerListPage"},{lp:{}}),this.form.load()},_ok:function(t,e){t&&("function"==typeof this.options.callback&&this.options.callback(),this.container.getElement("#customer").setAttribute("value",t.customername),this.app.Customer=t,this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode&&this.formAreaNode.destroy(),this.fireEvent("postOk"))},loadData:function(){}}),MWF.xApplication.CRM.ChanceEdit.SelectCustomer=new Class({Extends:MWF.xApplication.CRM.Template.SelectForm,_getCurrentPageData:function(e,t,i,s){this.category=this.options.category;t||(t=10),i||(i=1);this.items.length&&this.items[this.items.length-1].data.id;var a=this.options.filterData||{};s&&(a={key:s}),this.actions.getCustomerListPage(i,t,a,function(t){e&&e(t)}.bind(this))}});