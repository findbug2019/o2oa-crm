MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.CRM.ClueOpen=new Class({Extends:MWF.xApplication.CRM.Template.PopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0},initialize:function(e,t,i,n){this.setOptions(n),this.explorer=e,this.app=e.app,this.lp=this.app.lp.clue.clueEdit,this.path="/x_component_CRM/$ClueEdit/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=i||{},this.actions=t,this.configData=[],this.imgArr=[],this.fileArr=[],this.isClueItem=!1,this.province=null},load:function(){(that=this).loadResource(function(){this.appArea=jQuery("body").children(":first"),this.createForm(),this.loadEvent()}.bind(this))},loadResource:function(e){e&&e()},createForm:function(){var e=jQuery("#clue").find("img");0<jQuery(e).attr("src").indexOf(jQuery(e).attr("dffill"))&&(this.isClueItem=!0);var t=this.options.clueName,i=that.getNotifyMax(),n=this.options.openStyle?this.options.openStyle:this.xxx;jQuery(".headMoreImg").notifyMe("right","default",t,'<div class = "headBottonDiv"><div class="headMoveBottonDiv">转移</div><div class="headEditBottonDiv">编辑</div><div class="headMoreBottonDiv"><span>更多</span><img class="headMoreImg" src="/x_component_CRM/$Clue/default/icons/arrow.png"></div></div>','<ul class="el-dropdown-menu"><li class="el-dropdown-menu__item">转化为客户</li><li class="el-dropdown-menu__item">删除</li><div class="popper__arrow"></div></ul>',"",i,500,n),this.createContentHtml(i)},getNotifyMax:function(){var e="notify",s=0;return this.options.openType&&"single"==this.options.openType||(jQuery(".notify").each(function(e,t){var i=jQuery(t).attr("id"),n=0;0<i.indexOf("_")?(n=parseInt(i.split("_")[1]),s<n&&(s=n)):0==s&&(s=1)}),0<s&&(e=e+"_"+s)),e},createContentHtml:function(e){that=this,that.sectionArea=jQuery("body")[0].getElement("#"+e),this.actions.getClueInfo(this.options.clueId,function(e){var t=e.data,i=""==t.owneruser?"--":t.owneruser.split("@")[0],n="<div class = 'briefdiv'><div class='div-inline'><div class='div-title'>线索来源</div><div class='div-value'>"+t.source+"</div></div><div class='div-inline'><div class='div-title'>手机</div><div class='div-value'>"+t.cellphone+"</div></div><div class='div-inline'><div class='div-title'>负责人</div><div class='div-value'>"+i+"</div></div><div class='div-inline'><div class='div-title'>更新时间</div><div class='div-value'>"+t.updateTime+"</div></div></div>";that.sectionArea.getElement(".notify-content").set("html",n+"<div class='tabPanel'><div class='hit'>跟进记录</div><div style='width:30px'></div><div>基本信息</div><div style='width:30px'></div><div>附件</div><div style='width:30px'></div><div>操作记录</div></div><div class='panes'><div class='pane' id='tab-follow' style='display:block;'><p>First tab content</p></div><div></div><div class='pane' id='tab-basicinfo'><p>Secend tab content</p></div><div></div><div class='pane' id='tab-att'><p>Third tab content</p></div><div></div><div class='pane' id='tab-options'><p>Four tab content</p></div></div>");var s=that.sectionArea.getSize();that.sectionArea.getElement(".panes").setStyles({height:s.y-250+"px"});that.sectionArea.getElement("#tab-follow").set("html",'<div ><div class="mix-container"><div class="i-cont"><div class="el-textarea el-input--suffix"><textarea autocomplete="off" placeholder="请输入内容" class="el-textarea__inner" style="resize: none; min-height: 57px; height: 57px;"></textarea></div></div><div class="vux-flexbox bar-cont vux-flex-row"><div class="vux-flexbox bar-item vux-flex-row"><input type="file"  id="bar-img" accept="image/*" multiple="multiple" class="bar-input"><img src="/x_component_CRM/$Template/img.png" class="bar-img"><div class="bar-title">图片</div></div><div class="splitdiv"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="vux-flexbox bar-item vux-flex-row" style="padding-left:0px;"><input type="file" id="bar-file" accept="*.*" multiple="multiple" class="bar-input"><img src="/x_component_CRM/$Template/file.png" class="bar-img"><div class="bar-title">附件</div></div></div></div><div  class="vux-flexbox se-section vux-flex-row"><div class="se-name">记录类型</div><div class="el-dropdown" style="margin-right: 20px;"><div class="vux-flexbox se-select vux-flex-row el-dropdown-selfdefine " ><div class="se-select-name">微信</div> <div class="el-icon-arrow-down el-icon--right"><img src="/x_component_CRM/$Clue/default/icons/arrow.png"></div></div> </div><div class="se-name">下次联系时间</div><div class="el-date-editor se-datepicker el-input el-input--prefix el-input--suffix el-date-editor--datetime"><input type="text"  autocomplete="off" name="" placeholder="选择日期" class="el-input__inner" id="stime" readonly="readonly"><span class="el-input__prefix"><i class="el-input__icon el-icon-time"></i></span><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="el-input__icon"></i></span></span></div><button type="button" class="el-button se-send el-button--primary"><span>发布</span></button></div><ul class="el-dropdown-type" style="display: none;" tid = "recordType"><li class="el-dropdown-menu__item">微信</li><li class="el-dropdown-menu__item">邮箱</li><li class="el-dropdown-menu__item">电话</li><li class="el-dropdown-menu__item">地址</li><div class="popper__arrow"></div></ul><div class="log-cont"><div class="log-inner1"><div class="log-inner2"><div class="log-items"><div class="load"><button  type="button" class="el-button el-button--text"><span>没有更多了</span></button></div></div><div class="empty-mask" style="display: none;"><div class="empty-content"><img src="/x_component_CRM/$Template/empty.png" class="empty-icon"> <p class="empty-text">没有找到数据</p></div></div></div><div class="el-loading-mask" style="display: none;"><div class="el-loading-spinner"><svg viewBox="25 25 50 50" class="circular"><circle cx="50" cy="50" r="20" fill="none" class="path"></circle></svg></div></div></div></div>'),that.loadTimeContainer("stime"),that.loadRecord()}.bind(this))},createTypeHtml:function(){var e=jQuery(this.sectionArea).find(".hit").text();"基本信息"==e&&this.getClueInfo(),"附件"==e&&this.loadAttachment(),"操作记录"==e&&this.loadOptions()},loadTimeContainer:function(e){jQuery("#"+e).ymdateplugin({showTimePanel:!0})},getClueInfo:function(){(_self=this).actions.getClueInfo(this.options.clueId,function(e){var t=e.data,n=_self.lp,s='<div class="section-conent">';for(i in n)s=s+'<div class="conent-inline"><div class="conent-title">'+n[i].text+'</div><div class="conent-value">'+t[i]+"</div></div>";s+="</div>",jQuery(_self.sectionArea).find("#tab-basicinfo").html('<div class="section-header"><div class="section-mark" style="border-left-color: rgb(70, 205, 207);"></div> <div data-v-ec8f8850="" class="section-title">基本信息</div></div>'+s)}.bind(this))},loadAttachment:function(){that=this;var e='<div class="rc-cont">';e+='<div class="vux-flexbox rc-head vux-flex-row" style="flex-direction: row-reverse;"><div class="rc-head-item"><span>上传附件</span></div> <input  type="file" id="afile" accept="*/*" multiple="multiple" class="rc-head-file"></div><div  class="el-table el-table--fit el-table--striped el-table--enable-row-hover" header-align="center" style="width: 100%; border: 1px solid rgb(230, 230, 230); height: 500px;" align="center"><div class="el-table__header-wrapper"><table class="el-table__header" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><thead class="has-gutter"><tr class=""><th colspan="1" rowspan="1" class="el-table_3_column_27     is-leaf" style="width: 40%;height:40px;"><div class="cell">附件名称</div></th><th colspan="1" rowspan="1" class="el-table_3_column_28     is-leaf" style="width: 10%;"><div class="cell">附件大小</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 20%;"><div class="cell">上传人</div></th><th colspan="1" rowspan="1" class="el-table_3_column_30     is-leaf" style="width: 20%;"><div class="cell">上传时间</div></th><th colspan="1" rowspan="1" class="el-table_3_column_26     is-leaf" style="width: 10%;"><div class="cell">操作</div></th></tr></thead></table></div><div class="el-table__body-wrapper is-scrolling-none" style="height: 450px;"><table class="el-table__body" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><tbody></tbody></table><div class="el-table__empty-block" style="width: 100%;"><span class="el-table__empty-text">暂无数据</span></div></div></div></div>',jQuery(that.sectionArea).find("#tab-att").html(e),jQuery(that.sectionArea).find("#afile").change(function(e){var t=jQuery(that.sectionArea).find("#afile")[0].files;jQuery(t).each(function(e,t){t.name;var i=new FormData;i.append("fileName",t.name),i.append("file",t),that.actions.updateAttachment("att",that.options.clueId,"leads",i,t,function(e){"success"==e.type&&that.getAttachment()}.bind(that))})}),that.getAttachment()},getAttachment:function(){var l=this;this.actions.getAttachment(this.options.clueId,function(e){if("success"==e.type){var t=e.data,n="";for(i in t)if(i<t.length){var s=t[i],a=s.length/1024,o=s.lastUpdatePerson;o=o.split("@")[0],n=n+'<tr><td style="width: 40%;height: 40px;" class="aname" aid="'+s.id+'" wcrm="'+s.wcrm+'">'+s.name+'</td><td style="width: 10%;">'+l.toDecimal(a)+'kb</td><td style="width: 20%;">'+o+'</td><td style="width: 20%;">'+s.updateTime+'</td><td class="attOption">删除</td></tr>'}""!=n&&(jQuery(l.sectionArea).find(".el-table__body").children().html(n),jQuery(l.sectionArea).find(".el-table__empty-block").hide(),jQuery(l.sectionArea).find(".attOption").click(function(){self=this,Showbo.Msg.confirm("提示","确定删除该附件吗?",function(){var e=jQuery(self).parent().children(":first").attr("aid");e&&""!=e&&l.actions.delAttachment(e,function(e){"success"==e.type&&jQuery(l.sectionArea).find(".hit").click()}.bind(self))},function(){})}),jQuery(l.sectionArea).find(".aname").click(function(){var e=l.actions.action.address+"/jaxrs/attachment/download/"+jQuery(this).attr("aid")+"/work/"+jQuery(this).attr("wcrm");window.open(e)}))}}.bind(l))},loadOptions:function(){that=this;jQuery(that.sectionArea).find("#tab-options").html('<div class="rc-cont"><div class="empty-mask" style="display:none;height:370px;"><div class="empty-content" style="margin-top:0px;"><img src="/x_component_CRM/$Template/empty.png" class="empty-icon"> <p class="empty-text">没有找到数据</p></div></div></div>'),this.actions.getOptionsRecord(this.options.clueId,function(e){if("success"==e.type){var t=e.data;jQuery(that.sectionArea).find(".rc-cont").find(".vux-flexbox").remove();var n="";for(i in t)if(i<t.length){var s=t[i],a="/x_component_CRM/$Template/portrait.png";s.hasOwnProperty("ICONBase64")&&""!=s.ICONBase64&&(a="data:image/png;base64,"+s.ICONBase64);var o=s.updateTime;n=n+'<div class="vux-flexbox ha-cont vux-flex-row" style="justify-content: flex-start; align-items: stretch;"><div class="ha-week">'+s.DateCN+'</div><div class="ha-circle"></div> <div class="ha-time">'+o.substring(11,16)+'</div><div class="div-photo ha-img xs-photo-parent--relative" style="background-image: url(&quot;'+a+'&quot;);" lazy="error"><div class="photo-wrap"></div></div><div class="ha-name">'+(s.person?s.person.name:s.createuser)+'</div><div class="ha-content">'+s.content+'</div><div class="ha-line"></div></div>'}""!=n&&jQuery(that.sectionArea).find(".rc-cont").append(n),t.length<1&&jQuery(that.sectionArea).find(".empty-mask").show()}}.bind(this))},transformToCustomer:function(){_self=this,Showbo.Msg.confirm("提示","确定将这些线索转化为客户吗?",function(){_self.confirmClue()},function(){})},confirmClue:function(){this.actions.transformToCustomer(this.options.clueId,function(e){"success"==e.type&&(this.isClueItem?Showbo.Msg.alert("转化成功!",jQuery("#clue").click()):Showbo.Msg.alert("转化成功!"))}.bind(this))},deleteClue:function(){_self=this,Showbo.Msg.confirm("提示","确定要删除此线索吗?",function(){_self.confirmDelClue()},function(){})},confirmDelClue:function(){this.actions.deleteClue(this.options.clueId,function(e){"success"==e.type&&(this.isClueItem?Showbo.Msg.alert("删除成功!",jQuery("#clue").click()):Showbo.Msg.alert("删除成功!"))}.bind(this))},transfer:function(){_self=this;Showbo.Msg.confirm("线索转移",'<div  class="vux-flexbox handle-item vux-flex-row" style="align-items: stretch;padding: 30px 20px 80px 20px;line-height:30px;"><div class="handle-item-name" style="margin-top: 8px;width:100px;">变更负责人为：</div><div class="el-select handle-item-content" style="margin-top: 8px;"><div class="se-select-name" id="selectName" style="display: inline-block;">+点击选择</div><div id="selectId" style="display:none;"></div></div></div>',function(){if(""==jQuery("#selectId").text())Showbo.Msg.alert("请选择负责人!");else{var e;e={distinguishName:jQuery("#selectId").text()},_self.actions.culeTransfer(_self.options.clueId,e,function(e){"success"==e.type&&(_self.isClueItem?Showbo.Msg.alert("操作成功!",jQuery("#clue").click()):Showbo.Msg.alert("操作成功!")),setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}.bind(_self))}},function(){}),jQuery(".ct").find(".se-select-name").click(function(){_self.selectPerson(jQuery(_self.appArea)[0],"selectName","selectId",1)})},clueEdit:function(){(_self=this).actions.getClueInfo(this.options.clueId,function(e){jQuery(_self.appArea).next().attr("style",""),jQuery(_self.appArea).next().attr("class","mask");var t=e.data,r=_self.lp,n='<div class="section-conent">';for(i in r){var s=r[i].type,a=r[i].notEmpty?r[i].notEmpty:"false",o='<input type="text" class="inline-input" name="'+i+'" id="'+i+'" notEmpty="'+a+'" stype="'+s+'" value="'+(void 0===t[i]?"":t[i])+'">';"textarea"==s&&(o='<textarea rows="6" class="el-textarea__inner"  id="'+i+'" notEmpty="'+a+'" stype="'+s+'"  style="resize: none; min-height: 30.6px;">'+t[i]+"</textarea>"),"select"==s&&(o='<div class="inline-input" style="display: inline-block;cursor:pointer;"  id="'+i+'" notEmpty="'+a+'" stype="'+s+'" >'+(void 0===t[i]?"":t[i])+'</div><div class="el-icon-arrow-down el-icon--right" style="margin-left: -20px; display: inline-block;"><img src="/x_component_CRM/$Clue/default/icons/arrow.png"></div>'),"datetime"==s&&(o='<input type="text" class="inline-input"  readonly="readonly" name="'+i+'" id="'+i+'" notEmpty="'+a+'" stype="'+s+'" value="'+(void 0===t[i]?"":t[i])+'">'),n=n+'<div class="conent-inline"><div class="conent-title" lable="'+i+'">'+r[i].text+'</div><div class="conent-value">'+o+"</div></div>","所在地区"==r[i].text&&(_self.province=void 0===t[i]?"":t[i])}var l='<div class="section-header"><div class="section-mark" style="border-left-color: rgb(70, 205, 207);"></div> <div data-v-ec8f8850="" class="section-title">基本信息</div></div>'+(n+="</div>")+'<div class="section_button"><div><button class="el-button handle-button el-button-cancle"><span>取消</span></button><button class="el-button handle-button el-button-primary"><span>保存</span></button></div></div>';jQuery(".headMoreImg").notifyMe("left","default","编辑线索","","",l,"notifyEdit",50),jQuery(".conent-value").each(function(e,t){var i=jQuery(t).children().eq(0),n=jQuery(i).attr("stype");if("datetime"==n&&_self.loadTimeContainer(jQuery(i).attr("id")),"select"==n){var s=_self.app.lp.clue;for(j in s)if(j==jQuery(i).attr("id")){var a=r[j].value.split(",");if(0<a.length){for(var o='<ul class="el-dropdown-type" style="display: none;" tid="'+jQuery(i).attr("id")+'">',l=0;l<a.length;l++)o=o+'<li class="el-dropdown-menu__item">'+a[l]+"</li>";jQuery(".notify-content").append(o+'<div class="popper__arrow"></div></ul>'),jQuery(i).click(function(){jQuery("[tid='"+jQuery(i).attr("id")+"']").css({left:jQuery(i).offset().left-50,top:jQuery(i).offset().top+30,width:282}),jQuery("[tid='"+jQuery(i).attr("id")+"']").toggle(100)}),jQuery("[tid='"+jQuery(i).attr("id")+"']").children().click(function(){jQuery(i).text(jQuery(this).text()),jQuery("[tid='"+jQuery(i).attr("id")+"']").toggle(100)})}}}}),_self.getAddress(),jQuery(".el-button-cancle").click(function(){setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}),jQuery(".el-button-primary").click(function(){var n=!0;if(jQuery(".inline-input[notempty='true']").each(function(e,t){if(""==jQuery(t).val()&&""==jQuery(t).text()){n=!1;var i=jQuery(t).parent().prev().text()+"不能为空";0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove(),jQuery(t).parent().append('<div class="empError" style="color:#f56c6c;padding: 0;line-height: 1;">'+i+"</div>")}else 0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove()}),n){var e="";"0"!=jQuery("[name='province']").val()&&(e=jQuery("[name='province']").val()+"#"+jQuery("[name='city']").val()+"#"+jQuery("[name='district']").val());var t;t={name:jQuery('div[lable="name"]').next().children().eq(0).val(),source:jQuery('div[lable="source"]').next().children().eq(0).text(),telephone:jQuery('div[lable="telephone"]').next().children().eq(0).val(),cellphone:jQuery('div[lable="cellphone"]').next().children().eq(0).val(),industry:jQuery('div[lable="industry"]').next().children().eq(0).text(),level:jQuery('div[lable="level"]').next().children().eq(0).text(),province:e,address:jQuery('div[lable="address"]').next().children().eq(0).val(),nexttime:jQuery('div[lable="nexttime"]').next().children().eq(0).val(),remark:jQuery('div[lable="remark"]').next().children().eq(0).val()},_self.actions.updateClue(_self.options.clueId,!0,t,function(e){"success"==e.type&&(_self.isClueItem?Showbo.Msg.alert("保存成功!",jQuery("#clue").click()):Showbo.Msg.alert("保存成功!")),setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}.bind(_self))}}),jQuery(".notify").click(function(e){jQuery(e.target).closest(".inline-input[notempty='true']").length<1&&jQuery(".inline-input[notempty='true']").each(function(e,t){if(""==jQuery(t).val()&&""==jQuery(t).text()){var i=jQuery(t).parent().prev().text()+"不能为空";0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove(),jQuery(t).parent().append('<div class="empError" style="color:#f56c6c;padding: 0;line-height: 1;">'+i+"</div>")}else 0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove()})})}.bind(this))},getAddress:function(){var e=this,t=[];o2.Actions.get("x_general_assemble_control").listProvince(function(e){e.data.each(function(e){t.push(e.name)}.bind(this))}.bind(this),null,!1);for(var i="",n=0;n<t.length;n++)i=i+'<option value="'+t[n]+'">'+t[n]+"</option>";var s='<select name="province" class="select-address"><option value="0">所在省</option>'+i+'</select><select name="city" class="select-address city-address"> <option value="0">所在市</option></select> <select class="select-address" name="district"><option value="0">所在区</option></select>';if(jQuery("#province").parent().append(s),jQuery("#province").remove(),null!=e.province){var a=e.province.split("#");1<a.length&&(jQuery("[name='province']").append(new Option(a[0],a[0])),jQuery("[name='province']").val(a[0]),"0"!=a[1]&&(jQuery("[name='city']").append(new Option(a[1],a[1])),jQuery("[name='city']").val(a[1])),"0"!=a[2]&&(jQuery("[name='district']").append(new Option(a[2],a[2])),jQuery("[name='district']").val(a[2])))}jQuery("[name='province']").change(function(){"0"!=jQuery("[name='province']").val()&&e.getCity(this.value)}),jQuery("[name='city']").change(function(){"0"!=jQuery("[name='province']").val()&&"0"!=jQuery("[name='city']").val()&&e.getDistrict(jQuery("[name='province']").val(),this.value)})},getCity:function(e){jQuery("[name='city']").find("option[value!='0']").remove(),jQuery("[name='district']").find("option[value!='0']").remove();var t=jQuery("[name='city']");"所在省"!=e&&o2.Actions.get("x_general_assemble_control").listCity(e,function(e){e.data.each(function(e){jQuery(t).append(new Option(e.name,e.name))})}.bind(this),null,!1)},getDistrict:function(e,t){jQuery("[name='district']").find("option[value!='0']").remove();var i=jQuery("[name='district']");o2.Actions.get("x_general_assemble_control").listDistrict(e,t,function(e){e.data.each(function(e){jQuery(i).append(new Option(e.name,e.name))})},null,!1)},loadEvent:function(){that=this,jQuery(that.sectionArea).find(".tabPanel div").click(function(){jQuery(this).addClass("hit").siblings().removeClass("hit"),jQuery(that.sectionArea).find(".panes>div:eq("+jQuery(this).index()+")").show().siblings().hide(),that.createTypeHtml()}),jQuery(that.sectionArea).find(".headMoreBottonDiv").click(function(){jQuery(that.sectionArea).find(".el-dropdown-menu").toggle(100)}),jQuery(that.sectionArea).find(".el-dropdown-menu__item").click(function(){"转化为客户"==jQuery(this).text()&&that.transformToCustomer(),"删除"==jQuery(this).text()&&that.deleteClue(),"recordType"==jQuery(this).parent().attr("tid")&&(jQuery(that.sectionArea).find(".se-select-name").text(jQuery(this).text()),jQuery(this).parent().toggle(100))}),jQuery(that.sectionArea).find(".headMoveBottonDiv").click(function(){that.transfer()}),jQuery(that.sectionArea).find(".headEditBottonDiv").click(function(){that.clueEdit()}),jQuery(that.sectionArea).find(".bar-input").change(function(e){var t=e.target.id,i=e.target.files,n="";if(i&&0<i.length){n='<div class="fileList">';for(var s=0;s<i.length;s++){var a=i[s],o=a.size/1024;n=n+'<div class="fileItem"><div class="fname">'+a.name+'</div><div class="fsize">'+that.toDecimal(o)+'kb</div><div class="ftime">'+that.getFormateTime(new Date)+"</div></div>","bar-img"==t&&that.imgArr.push(a),"bar-file"==t&&that.fileArr.push(a)}n+="</div>",jQuery(that.sectionArea).find(".mix-container").append(n)}}),jQuery(that.sectionArea).find(".se-send").click(function(){that.sendRecord()}),jQuery(that.sectionArea).find(".el-dropdown-selfdefine").click(function(){jQuery(that.sectionArea).find("[tid='recordType']").toggle(100)})},sendRecord:function(){that=this;var e;e={types:"leads",typesid:that.options.clueId,content:jQuery(that.sectionArea).find(".el-textarea__inner").val(),category:jQuery(that.sectionArea).find(".se-select-name").text(),nexttime:jQuery(that.sectionArea).find(".hasDatepicker").val(),businessids:"",contactsids:"",createuser:""},that.actions.createRecord(e,function(n){if("success"==n.type){Showbo.Msg.alert("跟进记录发布成功!");var e=jQuery(that.sectionArea).find("#bar-file")[0];jQuery(that.fileArr).each(function(e,t){t.name;var i=new FormData;i.append("fileName",t.name),i.append("file",t),that.actions.updateAttachment("att",n.data.id,"record",i,t,function(e){}.bind(that))});var t=jQuery(that.sectionArea).find("#bar-img")[0];jQuery(that.imgArr).each(function(e,t){t.name;var i=new FormData;i.append("fileName",t.name),i.append("file",t),that.actions.updateAttachment("img",n.data.id,"record",i,t,function(e){}.bind(that))}),e.value="",t.value="",that.fileArr=[],that.imgArr=[],0<jQuery(".fileList").length&&jQuery(".fileList").remove(),jQuery(".el-textarea__inner").val(""),that.loadRecord()}}.bind(that),function(e,t,i){}.bind(that))},loadRecord:function(){(that=this).actions.getRecord(this.options.clueId,function(e){if("success"==e.type){var t=e.data;jQuery(that.sectionArea).find(".fl-c").remove();var n="";for(i in t)if(i<t.length){var s=t[i],a="/x_component_CRM/$Template/portrait.png";s.hasOwnProperty("ICONBase64")&&""!=s.ICONBase64&&(a="data:image/png;base64,"+s.ICONBase64);var o="";if(0<s.attachmentListPreview.length){o+='<div class="my-gallery">';var l=s.attachmentListPreview;for(j in l)if(j<l.length){var r=l[j],c=this.actions.action.address+"/jaxrs/attachment/download/"+r.id+"/work/"+r.wcrm;o=o+'<figure><div class="fl-b-img-item"><a href="'+c+'" data-size="500x400"><img style="height:100%;" src="'+c+'"></a></div><figcaption style="display:none;">'+r.name+"</figcaption></figure>"}o+="</div>"}if(0<s.attachmentList.length){o+='<div class="fl-b-files">';var d=s.attachmentList;for(j in d)if(j<d.length){var p=d[j];o=o+'<div class="vux-flexbox cell vux-flex-row"><img  src="/x_component_CRM/$Record/default/icons/att.png" class="cell-head"> <div class="cell-body">'+p.name+'<span  style="color: rgb(204, 204, 204);">（'+that.toDecimal(p.length)+'KB）</span></div><button  type="button" class="el-button el-button--primary aname" aid="'+p.id+'" wcrm="'+p.wcrm+'"><img  src="/x_component_CRM/$Record/default/icons/down.png" style="margin-bottom:-3px;"><span>下载</span></button></div>'}o+="</div>"}n=n+'<div class="fl-c"><div class="vux-flexbox fl-h vux-flex-row"><img class="div-photo fl-h-img"  style="background-image: url(&quot;'+a+'&quot;);" lazy="loaded"></img> <div class="fl-h-b"><div class="fl-h-name">'+(s.person?s.person.name:s.createuser)+'</div><div class="fl-h-time">'+s.updateTime+'</div></div></div><div class="fl-b"><div class="fl-b-content">'+s.content+"</div>"+o+'<div class="follow"><span class="follow-info">'+s.category+'</span></div></div><div  class="full-container" style="display: none;"></div></div>'}""!=n&&jQuery(that.sectionArea).find(".load").before(n),t.length<1?(jQuery(that.sectionArea).find(".load").hide(),jQuery(that.sectionArea).find(".empty-mask").show()):jQuery(that.sectionArea).find(".empty-mask").hide(),jQuery(".aname").click(function(){var e=that.actions.action.address+"/jaxrs/attachment/download/"+jQuery(this).attr("aid")+"/work/"+jQuery(this).attr("wcrm");window.open(e)}),jQuery("figure").each(function(e,t){var i=jQuery(t).find("a").attr("href"),n=new Image;n.src=i,n.complete?jQuery(t).find("a").attr("data-size",n.width+"x"+n.height):n.onload=function(){jQuery(t).find("a").attr("data-size",n.width+"x"+n.height)}}),MWF.xDesktop.requireApp("CRM","PicTool",function(){that.PicToolModule=new MWF.xApplication.CRM.PicTool(that.app),0<jQuery(".my-gallery").length&&that.PicToolModule.initPhotoHtml(".notify"),that.PicToolModule.initPhotoSwipeFromDOM(".my-gallery")}.bind(that)),jQuery(".my-gallery>figure>div").each(function(){jQuery(this).height(jQuery(this).width())})}}.bind(this))},open:function(e){this.fireEvent("queryOpen"),this._open(),this.fireEvent("postOpen")},create:function(){this.fireEvent("queryCreate"),this.isNew=!0,this._open(),this.fireEvent("postCreate")},edit:function(){this.fireEvent("queryEdit"),this.isEdited=!0,this._open(),this.fireEvent("postEdit")},_open:function(){if(this.options.hasMask&&(this.formMaskNode=new Element("div.formMaskNode",{styles:this.css.formMaskNode,events:{mouseover:function(e){e.stopPropagation()},mouseout:function(e){e.stopPropagation()},click:function(e){e.stopPropagation()}}}).inject(this.container||this.app.content)),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.createFormNode(),this.formAreaNode.inject(this.formMaskNode||this.container||this.app.content,"after"),this.formAreaNode.fade("in"),this.setFormNodeSize(),this.setFormNodeSizeFun=this.setFormNodeSize.bind(this),this.app&&this.app.addEvent("resize",this.setFormNodeSizeFun),this.options.draggable&&this.formTopNode){var e=(this.container||this.app.content).getSize(),t=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,e.x-t.x],y:[0,e.y-t.y]}})}},createFormNode:function(){this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.formAreaNode),this.options.hasTop&&this.createTopNode(),this.options.hasIcon&&(this.formIconNode=new Element("div.formIconNode",{styles:this.isNew?this.css.formNewNode:this.css.formIconNode}).inject(this.formNode)),this.createContent(),this.options.hasBottom&&this.createBottomNode(),this._setCustom(),this.options.hasScroll&&MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.formTableContainer,{indent:!1,style:"default",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(e){}})}.bind(this))},createContent:function(){this.formContentNode=new Element("div.formContentNode",{styles:this.css.formContentNode}).inject(this.formNode),this.formTableContainer=new Element("div.formTableContainer",{styles:this.css.formTableContainer}).inject(this.formContentNode),this.formTableArea=new Element("div.formTableArea",{styles:this.css.formTableArea,text:"loading..."}).inject(this.formTableContainer),this._createTableContent()},createBottomNode:function(){this.formBottomNode=new Element("div.formBottomNode",{styles:this.css.formBottomNode}).inject(this.formNode),this._createBottomContent()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title+(this.data.title?"-"+this.data.title:"")}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(){this.loadFormData()},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.actionCancel}).inject(this.formBottomNode),(this.options.isNew||this.options.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.actionConfirm}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(e){this.ok(e)}.bind(this))),this.cancelActionNode.addEvent("click",function(e){this.cancel(e)}.bind(this))},loadFormData:function(){this.loadForm()},ok:function(e){this.fireEvent("queryOk");var t=this.form.getResult(!0,",",!0,!1,!0);t&&this._ok(t,function(e){"error"==e.type?this.app&&this.app.notice(e.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postOk"))}.bind(this))},loadForm:function(){(_self=this).form=new MForm(this.formTableArea,this.data,{style:"default",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app,this.css);var e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>",t=this.form.itemTemplate;for(i in t)e=e+"<tr>   <td styles='formTableTitle'><span lable='"+i+"'>"+t[i].text+"</td>   <td styles='formTableValue' item='"+i+"'></td></tr>";e+="</table>",this.formTableArea.set("html",e),this.form.load(),this.isNew||this.actions.getClueInfo(this.options.clueId,function(e){var t=e.data,i=this.formTableArea.getElements("span");for(j in i)if(j<i.length&&null!=i[j].get("name")){var n=i[j].get("name");for(var s in t)s==n&&i[j].set("text",t[s])}}.bind(this)),this.formTableArea.getElements("textarea").setStyles({height:"100px",overflow:"auto",color:"#666666"}),this.formTableArea.getElements("input").setStyles({color:"#666666"})},getItemTemplate:function(e){return _self=this,{name:{text:e.name,type:"text",notEmpty:!0,value:this.customerData&&this.customerData.customername?this.customerData.customername:""},source:{type:"text",notEmpty:!0,text:e.source},telephone:{type:"text",notEmpty:!0,text:e.telephone},cellphone:{notEmpty:!0,text:e.cellphone},industry:{type:"select",notEmpty:!0,text:e.industry,value:this.app.lp.clue.industry.value},level:{type:"select",text:e.level,notEmpty:!0,value:this.app.lp.clue.level.value},address:{text:e.address,name:"address",notEmpty:!0,type:"text"},nexttime:{text:e.nexttime,name:"nexttime",notEmpty:!0,attr:{id:"nexttime"},type:"datetime"},remark:{text:e.remark,name:"remark",type:"textarea"}}},selectPerson:function(e,t,s,i){var n={type:"",types:["person"],values:this.configData,count:i,zIndex:5e4,onComplete:function(e){MWF.require("MWF.widget.O2Identity",function(){var i=[],n=[];this.configData=[],this.process=null,e.each(function(e){if("i"==e.data.distinguishedName.split("@").getLast().toLowerCase()){new MWF.widget.O2Identity(e.data,it.form.getItem("invitePersonList").container,{style:"room"});i.push(e.data.distinguishedName)}else{i.push(e.data.name),n.push(e.data.distinguishedName);var t={name:e.data.name,distinguishedName:e.data.distinguishedName,employee:e.data.employee};this.configData.push(t)}}.bind(this)),0==e.length?document.getElementById(t).innerHTML="+点击选择":(document.getElementById(t).innerHTML=i.join(","),""!=s&&(document.getElementById(s).innerHTML=n.join(",")))}.bind(this))}.bind(this)};new MWF.O2Selector(e,n)},getFormateTime:function(e){_self=this;var t=new Date(e);return t.getFullYear()+"-"+_self.checkTime(t.getMonth()+1)+"-"+_self.checkTime(t.getDate())+" "+_self.checkTime(t.getHours())+":"+_self.checkTime(t.getMinutes())+":"+_self.checkTime(t.getSeconds())},checkTime:function(e){return e<10&&(e="0"+e),e},toDecimal:function(e){if(""==e)return"";var t=parseFloat(e);return isNaN(t)?e:t=Math.round(100*e)/100},createCustomBottom:function(){this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.actionConfirm}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(e){this.ok(e)}.bind(this))},_ok:function(data,callback){var saveDataStr="";for(i in this.data)saveDataStr=saveDataStr+"'"+i+"':'"+this.data[i]+"',";saveDataStr="'{"+saveDataStr.replace(/'/g,'"')+"}'";var saveData=eval("("+saveDataStr.substring(1,saveDataStr.length-1)+")");this.app.createShade(),this.actions.saveClue(saveData,function(e){this.app.destroyShade(),this.app.notice(this.lp.saveSuccess,"success"),this.close(),this.fireEvent("reloadView",e)}.bind(this),function(e,t,i){this.app.showErrorMessage(e,t,i),this.app.destroyShade()}.bind(this))}});