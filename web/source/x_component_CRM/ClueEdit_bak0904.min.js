MWF.xApplication.CRM.ClueEdit=new Class({Extends:MWF.xApplication.CRM.Template.PopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0},initialize:function(t,e,o,i){this.setOptions(i),this.explorer=t,this.app=t.app,this.lp=this.app.lp.clue.clueEdit,this.path="/x_component_CRM/$ClueEdit/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=o||{},this.actions=e},load:function(){this.createForm()},createForm:function(){this.allArrowArr=[],this.options.isNew?this.create():this.options.isEdited?this.edit():this.open(),this.formContentNode.addEvents({click:function(){this.listContentDiv&&this.listContentDiv.destroy(),0<this.allArrowArr.length&&this.allArrowArr.each(function(t){t.setStyles({background:"url(/x_component_CRM/$Template/default/icons/arrow.png) no-repeat center"})}.bind(this))}.bind(this)})},open:function(t){this.fireEvent("queryOpen"),this._open(),this.fireEvent("postOpen")},create:function(){this.fireEvent("queryCreate"),this.isNew=!0,this._open(),this.fireEvent("postCreate")},edit:function(){this.fireEvent("queryEdit"),this.isEdited=!0,this._open(),this.fireEvent("postEdit")},_open:function(){if(this.options.hasMask&&(this.formMaskNode=new Element("div.formMaskNode",{styles:this.css.formMaskNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()},click:function(t){t.stopPropagation()}}}).inject(this.container||this.app.content)),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.createFormNode(),this.formAreaNode.inject(this.formMaskNode||this.container||this.app.content,"after"),this.formAreaNode.fade("in"),this.setFormNodeSize(),this.setFormNodeSizeFun=this.setFormNodeSize.bind(this),this.app&&this.app.addEvent("resize",this.setFormNodeSizeFun),this.options.draggable&&this.formTopNode){var t=(this.container||this.app.content).getSize(),e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})}},createFormNode:function(){this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.formAreaNode),this.options.hasTop&&this.createTopNode(),this.options.hasIcon&&(this.formIconNode=new Element("div.formIconNode",{styles:this.isNew?this.css.formNewNode:this.css.formIconNode}).inject(this.formNode)),this.createContent(),this.options.hasBottom&&this.createBottomNode(),this._setCustom(),this.options.hasScroll&&MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.formTableContainer,{indent:!1,style:"default",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){}})}.bind(this))},createContent:function(){this.formContentNode=new Element("div.formContentNode",{styles:this.css.formContentNode}).inject(this.formNode),this.formTableContainer=new Element("div.formTableContainer",{styles:this.css.formTableContainer}).inject(this.formContentNode),this.formTableArea=new Element("div.formTableArea",{styles:this.css.formTableArea,text:"loading..."}).inject(this.formTableContainer),this._createTableContent()},createBottomNode:function(){this.formBottomNode=new Element("div.formBottomNode",{styles:this.css.formBottomNode}).inject(this.formNode),this._createBottomContent()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title+(this.data.title?"-"+this.data.title:"")}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(){this.loadFormData()},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.actionCancel}).inject(this.formBottomNode),(this.options.isNew||this.options.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.actionConfirm}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},loadFormData:function(){this.loadForm()},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,",",!0,!1,!0);e&&this._ok(e,function(t){"error"==t.type?this.app&&this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postOk"))}.bind(this))},loadForm:function(){(_self=this).form=new MForm(this.formTableArea,this.data,{style:"default",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app,this.css);var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>",e=this.form.itemTemplate;for(i in e)t=t+"<tr>   <td styles='formTableTitle'><span lable='"+i+"'>"+e[i].text+"</td>   <td styles='formTableValue' item='"+i+"'></td></tr>";t+="</table>",this.formTableArea.set("html",t),this.form.load(),this.isNew||this.actions.getClueInfo(this.options.clueId,function(t){var e=t.data,o=this.formTableArea.getElements("span");for(j in o)if(j<o.length&&null!=o[j].get("name")){var i=o[j].get("name");for(var s in e)s==i&&o[j].set("text",e[s])}}.bind(this)),this.formTableArea.getElements("textarea").setStyles({height:"100px",overflow:"auto",color:"#666666"}),this.formTableArea.getElements("input").setStyles({color:"#666666"})},getItemTemplate:function(t){return _self=this,{name:{text:t.name,type:"text",notEmpty:!0,value:this.customerData&&this.customerData.customername?this.customerData.customername:""},source:{text:t.source},telephone:{text:t.telephone},cellphone:{text:t.cellphone},industry:{text:t.industry},level:{text:t.level},address:{text:t.address,name:"address",type:"textarea",value:this.customerData&&this.customerData.address?this.customerData.address:""},nexttime:{text:t.nexttime,name:"nexttime",attr:{id:"nexttime"},tType:"datetime"},remark:{text:t.remark,name:"remark",type:"textarea"}}},createCustomBottom:function(){this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.actionConfirm}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))},_ok:function(data,callback){var saveDataStr="";for(i in this.data)saveDataStr=saveDataStr+"'"+i+"':'"+this.data[i]+"',";saveDataStr="'{"+saveDataStr.replace(/'/g,'"')+"}'";var saveData=eval("("+saveDataStr.substring(1,saveDataStr.length-1)+")");this.app.createShade(),this.actions.saveClue(saveData,function(t){this.app.destroyShade(),this.app.notice(this.lp.saveSuccess,"success"),this.close(),this.fireEvent("reloadView",t)}.bind(this),function(t,e,o){this.app.showErrorMessage(t,e,o),this.app.destroyShade()}.bind(this))}});