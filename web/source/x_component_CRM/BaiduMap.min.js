MWF.xApplication.CRM=MWF.xApplication.CRM||{},MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("CRM","Template",null,!1),MWF.require("MWF.widget.Identity",null,!1),MWF.xApplication.CRM.BaiduMap=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,a,o){this.setOptions(o),this.app=e,this.explorer=i,this.lp=e.lp.BaiduMap,this.path="/x_component_CRM/$BaiduMap/",this.loadCss(),this.actions=a,this.node=$(t)},loadCss:function(){this.cssPath="/x_component_CRM/$BaiduMap/"+this.options.style+"/css.wcss",this._loadCss()},load:function(t){this.markerData=t,this.mapNode=new Element("div.mapNode",{styles:{width:"100%",height:"99%",id:"mapMaxNode"}}).inject(this.node),setTimeout(function(){this.loadResource(function(){if(this.options.from="newCustomer"){var e=this;this.mapLocation=this.explorer.formTableArea.getElement("#mapLocation"),this.mapLocation.set("disabled",!1),this.mapLocation.setStyles({"background-color":"#ffffff"}),this.mapLocation.addEvents({keyup:function(){e.explorer.adDiv&&e.explorer.adDiv.destroy(),e.explorer.adDiv=new Element("div.adDiv",{styles:e.explorer.css.adDiv}).inject(this.getParent()),e.explorer.adDiv.setStyles({width:this.getWidth()+"px"});var t=this.get("value");if(""!=t)new Request.JSONP({url:"http://map.baidu.com/su?wd="+t,data:{cid:"131",type:"0",from:"jsapi"},onRequest:function(t){},onComplete:function(t){e.resolve(t)}}).send();else e.explorer.adDiv.destroy(),e.explorer.data.lat="",e.explorer.data.lng=""},blur:function(){}})}}.bind(this))}.bind(this),100)},loadMax:function(t){this.markerData=t,this.maxMapDiv=new Element("div.maxMapDiv",{styles:this.css.maxMapDiv}).inject(this.app.content),this.maxMapDiv.addEvents({click:function(){this.maxMapDiv.destroy()}.bind(this)}),this.mapHeadDiv=new Element("div.mapHeadDiv",{styles:this.css.mapHeadDiv}).inject(this.maxMapDiv),this.maxCloseDiv=new Element("div.maxCloseDiv",{styles:this.css.maxCloseDiv}).inject(this.mapHeadDiv),this.maxCloseDiv.addEvents({mouseenter:function(){this.setStyles({opacity:"1",filter:"alpha(opacity=100)"})},mouseleave:function(){this.maxCloseDiv.setStyles(this.css.maxCloseDiv)}.bind(this),click:function(){this.maxMapDiv.destroy()}.bind(this)}),this.maxMapDiv.addEvents({click:function(){this.maxMapDiv.destroy()}.bind(this)}),this.mapContentDiv=new Element("div.mapContentDiv",{styles:this.css.mapContentDiv}).inject(this.maxMapDiv),this.mapContentDiv.setStyles({height:this.app.content.getHeight()-this.mapHeadDiv.getHeight()-100+"px",width:this.app.content.getWidth()-100+"px"}),this.mapContentDiv.addEvents({click:function(t){t.stopPropagation()}}),this.mapNode=new Element("div.mapNode",{styles:{width:"100%",height:"99%",id:"mapMaxNode"}}).inject(this.mapContentDiv),setTimeout(function(){this.loadResource()}.bind(this),5)},loadResource:function(t){window.BMap_loadScriptTime=(new Date).getTime();window.BDMapApiLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.loadDom("http://api.map.baidu.com/getscript?v=2.0&ak=Qac4WmBvHXiC87z3HjtRrbotCE3sC9Zg&services=&t=20161219171637",function(){window.BDMapApiLoaded=!0,window.BDMarkerToolLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.load("/x_component_CRM/BDMarkerTool.js",function(){window.BDMarkerToolLoaded=!0,this._loadMap(),t&&t()}.bind(this))}.bind(this))},_loadMap:function(){if(this.markerData)this.loadMap();else if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(this.loadMap.bind(this),this.loadMap.bind(this),{timeout:500})}catch(t){this.loadMap()}else this.loadMap()},loadMap:function(t){this.createMap(t)},createMap:function(t){var e=null;this.markerData.longitude&&this.markerData.latitude?e=new BMap.Point(this.markerData.longitude,this.markerData.latitude):(t&&t.coords&&(e=new BMap.Point(t.coords.longitude,t.coords.latitude)),e||(e=new BMap.Point(116.404,39.915))),this.map=new BMap.Map(this.mapNode);var i=new BMap.Marker(e);this.map.addOverlay(i),this.map.centerAndZoom(e,14),this.map.panTo(e),this.map.enableScrollWheelZoom(!0)},resolve:function(t){var r=this;t&&t.s&&t.s.each(function(t,e){var i=t.split("$"),a=i[0],l=i[1]||a,d=i[3]||a;""!=a&&new Element("li.adLi",{styles:this.explorer.css.adLi,text:a+"-"+l+"-"+d,city:a}).inject(this.explorer.adDiv).addEvents({click:function(s){var n=this.get("city");r.map.clearOverlays();var p=new BMap.LocalSearch(n,{onSearchComplete:function(){var t=p.getResults().getPoi(0).point,e=p.getResults().province,i=t.lat,a=t.lng,o=e==n?n+l+d:e+n+l+d;r.mapLocation.set("value",o),r.explorer.data.lat=i,r.explorer.data.lng=a,r.map.centerAndZoom(t,18),r.map.addOverlay(new BMap.Marker(t)),r.app.confirm("warn",s,r.app.lp.confirm.customForm.replaceLocation.title,r.app.lp.confirm.customForm.replaceLocation.content,300,120,function(){r.explorer.formTableArea.getElement("#TProvinceValue").set("text",e),r.explorer.formTableArea.getElement("#TCityValue").set("text",n),r.explorer.formTableArea.getElement("#TAreaValue").set("text",l),r.explorer.form.getItem("TStreet").set("value",d),r.explorer.adDiv.destroy(),this.close()},function(){this.close(),r.explorer.adDiv.destroy()})}});p.search(d)},mouseover:function(){this.setStyles({background:"#999999",color:"#ffffff"})},mouseout:function(){this.setStyles({background:"#ffffff",color:""})}})}.bind(this))},setPlace:function(t){this.map.clearOverlays();var e=new BMap.LocalSearch(this.map,{onSearchComplete:function(){var t=e.getResults().getPoi(0).point;this.map.centerAndZoom(t,18),this.map.addOverlay(new BMap.Marker(t))}.bind(this)});e.search(t)}}),MWF.xApplication.CRM.BaiduMap.MaxMap=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",width:"100%",height:"100%"},initialize:function(t,e,i,a){this.setOptions(a),this.app=e,this.explorer=t,this.lp=e.lp.BaiduMap,this.path="/x_component_CRM/$BaiduMap/",this.loadCss(),this.actions=i},loadCss:function(){this.cssPath="/x_component_CRM/$BaiduMap/"+this.options.style+"/css.wcss",this._loadCss()},load:function(t,e){this.maxMapDiv=new Element("div.maxMapDiv",{styles:this.css.maxMapDiv}).inject(this.app.content),this.mapHeadDiv=new Element("div.mapHeadDiv",{styles:this.css.mapHeadDiv}).inject(this.maxMapDiv),this.mapContentDiv=new Element("div.mapContentDiv",{styles:this.css.mapContentDiv}).inject(this.maxMapDiv),this.mapContentDiv.setStyles({height:this.app.content.getHeight()-this.mapHeadDiv.getHeight()-100+"px",width:this.app.content.getWidth()-100+"px"}),setTimeout(function(){this.loadResource()}.bind(this),100)},loadResource:function(t){window.BMap_loadScriptTime=(new Date).getTime();window.BDMapApiLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.loadDom("http://api.map.baidu.com/getscript?v=2.0&ak=Qac4WmBvHXiC87z3HjtRrbotCE3sC9Zg&services=&t=20161219171637",function(){window.BDMapApiLoaded=!0,window.BDMarkerToolLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.load("/x_component_CRM/BDMarkerTool.js",function(){window.BDMarkerToolLoaded=!0,this._loadMap(),t&&t()}.bind(this))}.bind(this))},_loadMap:function(){if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(this.loadMap.bind(this),this.loadMap.bind(this))}catch(t){this.loadMap()}else this.loadMap()},loadMap:function(t){this.createMap(t)},createMap:function(t){var e=null;this.markerData?e=new BMap.Point(this.markerData.longitude,this.markerData.latitude):(t&&t.coords&&(e=new BMap.Point(t.coords.longitude,t.coords.latitude)),e||(e=new BMap.Point(116.404,39.915))),this.map=new BMap.Map(this.mapNode);var i=new BMap.Marker(e);this.map.addOverlay(i),this.map.panTo(e),this.map.centerAndZoom(e,12),this.map.enableScrollWheelZoom(!0)}});