MWF.xDesktop.requireApp("CRM","Explorer",null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xApplication.CRM.AddressExplorer=new Class({Extends:MWF.xApplication.CRM.Explorer,Implements:[Options,Events],initialize:function(t,e,i,a){this.setOptions(a),this.app=e,this.path="/x_component_CRM/$AddressExplorer/",this.cssPath="/x_component_CRM/$AddressExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(t),this.initData()},reload:function(){this.node.empty(),this.load()},load:function(){this.loadToolbar(),this.loadContentNode(),this.loadContent(),this.setNodeScroll()},destroy:function(){this.baiduMap&&(this.baiduMap.map.clearOverlays(),this.elementContentNode.destroy()),this.node.empty()},loadContent:function(t){this.elementContentNode.empty();this.baiduMap=new MWF.xApplication.CRM.AddressExplorer.BaiduMap(this.elementContentNode,this.app,this,{}),this.baiduMap.load([]),this.setContentSize()},reloadList:function(){this.actions.listWorkplace(function(t){this.wpContent.empty(),this.createList(t.data||[])}.bind(this))},createList:function(t){this.wdList=new Element("div",{styles:this.css.wdList}).inject(this.wpContent),this.wdList.setStyle("width",this.toolbarNode.getSize().x-200+"px"),t.each(function(t){new Element("div",{styles:this.css.toolbarContentItem,text:t.placeName}).inject(this.wdList).addEvent("click",function(t){this.obj.baiduMap.gotoMarker(this.data),t.stopPropagation()}.bind({obj:this,data:t}))}.bind(this)),this.arrow="up",this.wdList.getScrollSize().y>this.wpContent.getSize().y&&(this.wdList.addEvent("click",function(t){"down"!=this.arrow?this.openList(t):this.closeList(t)}.bind(this)),this.arrowNode=new Element("div.arrowNode",{styles:this.css.arrowNode}).inject(this.wpContent,"top"),this.arrowNode.addEvents({mouseover:function(){this.arrowNode.setStyles("down"!=this.categoryArrow?this.css.arrowNode_over:this.css.arrowNode_down_over)}.bind(this),mouseout:function(){this.arrowNode.setStyles("down"!=this.categoryArrow?this.css.arrowNode:this.css.arrowNode_down)}.bind(this),click:function(t){"down"!=this.arrow?this.openList(t):this.closeList(t)}.bind(this)}))},_setContentSize:function(){},openList:function(t){this.arrow="down",this.arrowNode.setStyle("display","none"),this.wdList.setStyles(this.css.wdList_all),window.closeList=this.closeList.bind(this),this.app.content.addEvent("click",window.closeList),t.stopPropagation()},closeList:function(t){this.arrow="up",this.arrowNode.setStyle("display",""),this.wdList.setStyles(this.css.wdList),this.app.content.removeEvent("click",window.closeList),t.stopPropagation()},createDocument:function(){this.baiduMap.createMarker()}}),MWF.xApplication.CRM.AddressExplorer.BaiduMap=new Class({Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,a){this.container=t,this.explorer=i,this.app=e,this.actions=i.actions,this.setOptions(a),this.markers={},this.markerInfoWindows={}},load:function(t){this.markerData=t,this.mapNode=new Element("div",{styles:{width:"100%",height:"99%"}}).inject(this.container),setTimeout(function(){this.loadResource()}.bind(this),200)},loadResource:function(t){window.BMap_loadScriptTime=(new Date).getTime();window.BDMapApiLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.loadDom("http://api.map.baidu.com/getscript?v=2.0&ak=Qac4WmBvHXiC87z3HjtRrbotCE3sC9Zg&services=&t=20161219171637",function(){window.BDMapApiLoaded=!0,window.BDMarkerToolLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.load("/x_component_CRM/BDMarkerTool.js",function(){window.BDMarkerToolLoaded=!0,this._loadMap(),t&&t()}.bind(this))}.bind(this))},_loadMap:function(){if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(this.loadMap.bind(this),this.loadMap.bind(this))}catch(t){this.loadMap()}else this.loadMap()},loadMap:function(t){this.createMap(t),this.addMapControl(),this.markerData&&this.addMarkerArray(this.markerData)},createMap:function(t){var e=null;if(t&&t.coords&&(e=new BMap.Point(t.coords.longitude,t.coords.latitude)),!e)if(this.markerData&&0<this.markerData.length){var i=this.markerData[0];e=new BMap.Point(i.longitude,i.latitude)}else e=new BMap.Point(120.122,30.298);var a=this.map=new BMap.Map(this.mapNode);a.centerAndZoom(e,12),a.enableScrollWheelZoom(!0)},addMapControl:function(){var t=new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_RIGHT,type:BMAP_NAVIGATION_CONTROL_LARGE});this.map.addControl(t);var e=new BMap.OverviewMapControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen:1});this.map.addControl(e);var i=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});this.map.addControl(i),this.addCityListControl()},addCityListControl:function(){this.map.addControl(new BMap.CityListControl({anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(10,20),onChangeBefore:function(){},onChangeAfter:function(){}}))},getInfoWindowHtml:function(t){t=t||{};var e=[];return e.push("<br/>"),e.push('<table border="0" cellpadding="1" cellspacing="1" id="markerTable" docId="'+(t.id||"")+'" style="font-size:12px;">'),e.push("  <tr>"),e.push('      <td style="width:50px" align="left" class="common">名称：</td>'),e.push('      <td style="width: 300px"><input type="text"  size="40" value="'+(t.placeName||"")+'" id="placeName" ></td>'),e.push('\t     <td style="width: 10px" valign="top"><span style="color:#ff0000">*</span></td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('      <td  align="left" class="common">别名：</td>'),e.push('      <td><input type="text" maxlength="300px" size="40"  value="'+(t.placeAlias||"")+'" id="placeAlias" ></td>'),e.push('\t     <td valign="top"></td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('      <td  align="left" class="common">范围：</td>'),e.push('      <td><input type="text" maxlength="300px" size="40"  value="'+(t.errorRange||"")+'" id="errorRange" ></td>'),e.push('\t     <td valign="top">米</td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('      <td align="left" class="common">备注：</td>'),e.push('      <td><textarea rows="4" cols="31"  id="description">'+(t.description||"")+"</textarea></td>"),e.push('\t     <td valign="top"></td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('\t     <td  align="center" colspan="3">'),e.push('          <input type="button" name="btnOK"  id="submitPlace" value="保存">&nbsp;&nbsp;'),t.id&&e.push('\t\t     <input type="button" name="btnMove" id="enableMovePlace" value="允许移动">&nbsp;&nbsp;'),e.push('\t\t     <input type="button" name="btnClear" id="cancelPlace" value="删除">'),e.push("\t     </td>"),e.push("  </tr>"),e.push("</table>"),e.join("")},createMarker:function(){var t=new BMapLib.MarkerTool(this.map,{autoClose:!0});t.addEventListener("markend",function(t){var e=t.marker.point;(new BMap.Geocoder).getLocation(e,function(t){var e=t.addressComponents,i=e.province.replace("省","").replace("市","").replace("自治区","").replace("回族","").replace("壮族","").replace("维吾尔",""),a=e.city,o=e.district;jQuery("#detailaddress").val(t.address),jQuery("#detailaddress").attr("location",i+","+a+","+o),jQuery("#detailaddress").attr("lng",t.point.lng),jQuery("#detailaddress").attr("lat",t.point.lat),jQuery("#detailaddress").attr("province",i),jQuery("#detailaddress").attr("city",a)});var i=t.marker;i.addEventListener("dragend",function(){var t=i.point;(new BMap.Geocoder).getLocation(t,function(t){var e=t.addressComponents,i=e.province.replace("省","").replace("市","").replace("自治区","").replace("回族","").replace("壮族","").replace("维吾尔",""),a=e.city,o=e.district;jQuery("#detailaddress").val(t.address),jQuery("#detailaddress").attr("location",i+","+a+","+o),jQuery("#detailaddress").attr("lng",t.point.lng),jQuery("#detailaddress").attr("lat",t.point.lat),jQuery("#detailaddress").attr("province",i),jQuery("#detailaddress").attr("city",a)})})}.bind(this)),t.open();var e=BMapLib.MarkerTool.SYS_ICONS[14];t.setIcon(e)},addMarkerArray:function(t){for(var e=0;e<t.length;e++){var i=t[e];this.addMarker(i)}},addMarker:function(a){var o=this,t=new BMap.Point(a.longitude,a.latitude),e=BMapLib.MarkerTool.SYS_ICONS[8],n=new BMap.Marker(t,{icon:e,enableDragging:!1}),s=new BMap.Label(a.placeName,{offset:new BMap.Size(0,-20)});n.setLabel(s),this.map.addOverlay(n),s.setStyle({borderColor:"#808080",color:"#333",cursor:"pointer"}),function(){var t=new BMap.InfoWindow(this.getInfoWindowHtml(a),{offset:new BMap.Size(0,-10)}),e=n,i=a;e.addEventListener("click",function(){this.openInfoWindow(t)}),e.addEventListener("dragend",function(){this.openInfoWindow(t)}),t.addEventListener("open",function(){e.getLabel().hide();var t=document.id("markerTable");t.getElements("[id='enableMovePlace']").addEvent("click",function(){this.obj.enableMove(this.mkr)}.bind({obj:this,mkr:e,table:t,id:i.id})),t.getElements("[id='submitPlace']").addEvent("click",function(){this.obj.ok(this.mkr,this.table,this.id)}.bind({obj:this,mkr:e,table:t,id:i.id})),t.getElements("[id='cancelPlace']").addEvent("click",function(){this.obj.cancel(this.mkr,this.table,this.id)}.bind({obj:this,mkr:e,table:t,id:i.id}))}.bind(o)),t.addEventListener("close",function(){e.getLabel().show()}),s.addEventListener("click",function(){e.openInfoWindow(t)}),this.markers[a.id]=n,this.markerInfoWindows[a.id]=t}.bind(this)()},enableMove:function(t){t.closeInfoWindow(),t.enableDragging()},gotoMarker:function(t){var e=this.markers[t.id];this.map.centerAndZoom(e.point,15),e.openInfoWindow(this.markerInfoWindows[t.id])},ok:function(e,t,i){var a=t.getElements("[id='placeName']")[0].get("value");if(""==a.trim())return this.app.notice("工作场所不能为空","error"),!1;var o=t.getElements("[id='placeAlias']")[0].get("value"),n=t.getElements("[id='description']")[0].get("value"),s={placeName:a,placeAlias:o,errorRange:t.getElements("[id='errorRange']")[0].get("value"),description:n,longitude:e.point.lng,latitude:e.point.lat};i&&(s.id=i),this.actions.saveWorkplace(s,function(t){s.id=t.data.message,e.closeInfoWindow(),e.remove(),this.addMarker(s),this.explorer.reloadList()}.bind(this))},cancel:function(e,t,i){if(i)this.actions.deleteWorkplace(i,function(){e.closeInfoWindow();var t=e.getLabel();t&&t.remove(),e.remove(),this.explorer.reloadList()}.bind(this));else{e.closeInfoWindow();var a=e.getLabel();a&&a.remove(),e.remove()}}});