MWF.xApplication.Attendance=MWF.xApplication.Attendance||{},MWF.xDesktop.requireApp("Attendance","lp."+MWF.language,null,!1),MWF.xApplication.Attendance.Calendar=new Class({Implements:[Options,Events],options:{date:null},initialize:function(t,e,n,i){this.setOptions(i),this.app=e.app,this.explorer=e,this.actions=this.app.actions,this.node=t,this.css=e.css,this.holiday=n.holiday,this.eventData=n.eventData,this.detail=n.detail,this.statusColor=e.statusColor},reload:function(){this.node.empty(),this.load()},load:function(){this.loadResource(function(){this.loadCalendar()}.bind(this))},loadResource:function(t){var e=["/x_component_Attendance/$Common/fullcalendar/lib/moment.js","/x_component_Attendance/$Common/fullcalendar/lib/jquery.js"];COMMON.AjaxModule.loadCss("/x_component_Attendance/$Common/fullcalendar/fullcalendar.css",function(){COMMON.AjaxModule.load(e,function(){jQuery.noConflict(),COMMON.AjaxModule.load("/x_component_Attendance/$Common/fullcalendar/fullcalendar.js",function(){COMMON.AjaxModule.load("/x_component_Attendance/$Common/fullcalendar/lang/zh-cn.js",function(){t&&t()}.bind(this))}.bind(this))}.bind(this))}.bind(this))},loadCalendar:function(){jQuery(this.node).fullCalendar({header:{left:"",center:"",right:""},contentHeight:350,defaultDate:this.options.date.format(this.app.lp.dateFormatDay),eventColor:"#fff",eventTextColor:"#fff",rendingNumberCellFun:function(t,e,n){return this.holiday&&this.holiday.holidays&&this.holiday.holidays.contains(e)?"<span style='float:right;padding-right:5px;color:red'>休</span>":this.holiday&&this.holiday.workdays&&this.holiday.workdays.contains(e)?"<span style='float:right;padding-right:5px;'>班</span>":void 0}.bind(this),eventMouseover:function(t,e,n){e.target.title=t.text},events:this.eventData})}}),MWF.xApplication.Attendance.Echarts=new Class({Implements:[Options,Events],options:{type:"pie",date:null},initialize:function(t,e,n,i){this.setOptions(i),this.app=e.app,this.lp=this.app.lp,this.actions=this.app.actions,this.node=t,this.css=e.css,this.data=n,this.statusColor=e.statusColor},load:function(){this.options.date||(this.options.date=new Date),this.year=this.options.date.getFullYear();var t=this.options.date.getMonth()+1;this.month=2==t.toString().length?t:"0"+t,this.loadResource(function(){"pie"==this.options.type?this.loadPieChart():this.loadLineChart()}.bind(this))},loadResource:function(t){COMMON.AjaxModule.load(["/x_component_Attendance/$Common/echarts/echarts.common.js"],function(){COMMON.AjaxModule.load("/x_component_Attendance/$Common/echarts/theme/shine.js",function(){t&&t()}.bind(this))}.bind(this))},loadPieChart:function(){this.chart=echarts.init(this.node,"shine"),this.chart.setOption({title:{text:"考勤汇总"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},series:[{name:"考勤状态",type:"pie",radius:["55%","70%"],avoidLabelOverlap:!1,label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"30",fontWeight:"bold"}}},labelLine:{normal:{show:!1}},data:this.getPieData()}]})},loadLineChart:function(){var a=this,s=this.options.cycleStart.getMonth()!=this.options.cycleEnd.getMonth(),t=this.getDateByMonth(),e=this.analyseLineData(),n={title:{text:"上下班走势图"},grid:{left:50,right:40},tooltip:{trigger:"axis",formatter:function(t){var e,n,i,o;return n=t[0].value&&"-"!=t[0].value?(o=1==(e=t[0].value.toString().split(".")).length?e[0]+":00":1==e[1].length?e[0]+":"+e[1]+"0":e.join(":"),t[0].seriesName+"  "+o):"",i=t[1].value&&"-"!=t[1].value?(o=1==(e=t[1].value.toString().split(".")).length?e[0]+":00":1==e[1].length?e[0]+":"+e[1]+"0":e.join(":"),t[1].seriesName+"  "+o):"",s?t[0].name+"<br />"+n+"<br />"+i:a.year+"-"+a.month+"-"+t[0].name+"<br />"+n+"<br />"+i}},legend:{data:["上班时间","下班时间"]}};n.yAxis={type:"value",min:0==e.yOffTime.length&&0==e.yOnTime.length?"5.00":"dataMin",max:0==e.yOffTime.length&&0==e.yOnTime.length?"23.00":"dataMax",axisLabel:{formatter:function(t){return vs=t.toString().split("."),1==vs.length?vs[0]+":00":1==vs[1].length?vs[0]+":"+vs[1]+"0":vs.join(":")}}},n.xAxis=[{type:"category",boundaryGap:!1,data:t,axisLabel:{}}],n.series=[{name:"上班时间",type:"line",data:e.yOnTime.map(function(t){return!t||isNaN(parseFloat(t.replace(":",".")))?"-":parseFloat(t.replace(":","."))})},{name:"下班时间",type:"line",data:e.yOffTime.map(function(t){return!t||isNaN(parseFloat(t.replace(":",".")))?"-":parseFloat(t.replace(":","."))})}],this.chart=echarts.init(this.node,"shine"),this.chart.setOption(n)},getPieData:function(){var t=[];for(var e in this.data)t.push({value:this.data[e],name:this.lp[e],itemStyle:{normal:{color:this.statusColor[e]}}});return t},getDateByMonth:function(){var t=[];if(this.options.cycleStart.getMonth()==this.options.cycleEnd.getMonth())for(var e=this.year||(new Date).getFullYear(),n=this.options.date.getMonth()||(new Date).getMonth(),i=new Date(e,n,1);i.getMonth()===n;)t.push(i.getDate()),i.setDate(i.getDate()+1);else for(var o=this.options.cycleStart.clone(),a=this.options.cycleEnd.clone();o<=a;)t.push(o.format("%Y-%m-%d")),o.setDate(o.getDate()+1);return this.allDates=t},analyseLineData:function(){var t=this.getDateByMonth(),i={};this.data.each(function(t,e){i[t.recordDateString]=t});var o=[],a=[];if(this.options.cycleStart.getMonth()==this.options.cycleEnd.getMonth()){var s=this.year||(new Date).getFullYear().toString(),h=this.options.date.format("%m");t.each(function(t,e){var n=i[s+"-"+h+"-"+(9<t?t:"0"+t)];n?(o.push(""!=n.onDutyTime?n.onDutyTime:"-"),a.push(""!=n.offDutyTime?n.offDutyTime:"-")):(o.push("-"),a.push("-"))})}else t.each(function(t,e){var n=i[t];n?(o.push(""!=n.onDutyTime?n.onDutyTime:"-"),a.push(""!=n.offDutyTime?n.offDutyTime:"-")):(o.push("-"),a.push("-"))});return{yOnTime:o,yOffTime:a}},loadUnitPieChart:function(){this.loadResource(function(){this._loadUnitPieChart()}.bind(this))},_loadUnitPieChart:function(){var t=this.getUnitPieData();this.chart=echarts.init(this.node,"shine"),this.chart.setOption({title:{text:"考勤汇总"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},series:[{name:"考勤状态",type:"pie",radius:["55%","70%"],avoidLabelOverlap:!1,label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"30",fontWeight:"bold"}}},labelLine:{normal:{show:!1}},data:t.data}]})},getUnitPieData:function(){var t={name:[],data:[]};for(var e in this.data)t.name.push(this.lp[e]),t.data.push({value:this.data[e],name:this.lp[e],itemStyle:{normal:{color:this.statusColor[e]}}});return t},loadUnitBarChart:function(){this.loadResource(function(){this._loadUnitBarChart()}.bind(this))},_loadUnitBarChart:function(){var t=this.getUnitBarData(),e={title:{text:"考勤趋势"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",data:t.name}],yAxis:[{type:"value"}],series:t.data};this.chart=echarts.init(this.node,"shine"),this.chart.setOption(e)},getUnitBarData:function(){var n={};this.data.each(function(t){for(var e in t.data)n[e]||(n[e]={month:[],name:this.lp[e],type:"bar",itemStyle:{normal:{color:this.statusColor[e]}},data:[]}),n[e].data.push(t.data[e]),n[e].month.push(t.year+"年"+t.month+"月")}.bind(this));var t={data:[]};for(var e in n)t.name||(t.name=n[e].month),t.data.push(n[e]);return t}}),MWF.xApplication.Attendance.MonthSelector=new Class({Implements:[Events],initialize:function(t,e){this.explorer=e,this.css=this.explorer.css,this.app=this.explorer.app,this.date=t,this.year=this.date.get("year"),this.load()},load:function(){this.monthSelectNode=new Element("div",{styles:this.css.calendarMonthSelectNode}).inject(this.explorer.node),this.monthSelectNode.position({relativeTo:this.explorer.titleTextNode,position:"bottomCenter",edge:"upperCenter"}),this.monthSelectNode.addEvent("mousedown",function(t){t.stopPropagation()}),this.monthSelectTitleNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNode}).inject(this.monthSelectNode),this.monthSelectPrevYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitlePrevYearNode}).inject(this.monthSelectTitleNode),this.monthSelectNextYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNextYearNode}).inject(this.monthSelectTitleNode),this.monthSelectTextNode=new Element("div",{styles:this.css.calendarMonthSelectTitleTextNode}).inject(this.monthSelectTitleNode),this.monthSelectTextNode.set("text",this.year);this.monthSelectTable=new Element("table",{styles:{"margin-top":"10px"},height:"200px",width:"90%",align:"center",border:"0",cellPadding:"0",cellSpacing:"5",html:"<tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr>"}).inject(this.monthSelectNode),this.monthSelectBottomNode=new Element("div",{styles:this.css.calendarMonthSelectBottomNode,text:this.app.lp.today}).inject(this.monthSelectNode),this.setEvent()},loadMonth:function(){this.monthSelectTextNode.set("text",this.year);var t=new Date,i=t.get("year"),o=t.get("month"),a=this.date.get("year"),s=this.date.get("month"),h=this;this.monthSelectTable.getElements("td").each(function(t,e){t.empty(),t.removeEvents("mouseover"),t.removeEvents("mouseout"),t.removeEvents("mousedown"),t.removeEvents("mouseup"),t.removeEvents("click");var n=e+1;t.store("month",n),t.setStyles(this.css.calendarMonthSelectTdNode),t.set("text",""+n+this.app.lp.month),t.setStyle("background-color","#FFF"),this.year==a&&e==s&&t.setStyle("background-color","#EEE"),this.year==i&&e==o&&t.setStyle("background-color","#CCC"),t.addEvents({mouseover:function(){this.setStyles(h.css.calendarMonthSelectTdNode_over)},mouseout:function(){this.setStyles(h.css.calendarMonthSelectTdNode)},mousedown:function(){this.setStyles(h.css.calendarMonthSelectTdNode_down)},mouseup:function(){this.setStyles(h.css.calendarMonthSelectTdNode_over)},click:function(){h.selectedMonth(this)}})}.bind(this))},setEvent:function(){this.monthSelectPrevYearNode.addEvent("click",function(){this.prevYear()}.bind(this)),this.monthSelectNextYearNode.addEvent("click",function(){this.nextYear()}.bind(this)),this.monthSelectBottomNode.addEvent("click",function(){this.todayMonth()}.bind(this))},prevYear:function(){this.year--,this.year<1900&&(this.year=1900),this.monthSelectTextNode.set("text",this.year),this.loadMonth()},nextYear:function(){this.year++,this.monthSelectTextNode.set("text",this.year),this.loadMonth()},todayMonth:function(){var t=new Date;this.explorer.changeMonthTo(t),this.hide()},selectedMonth:function(t){var e=t.retrieve("month"),n=Date.parse(this.year+"/"+e+"/1");this.explorer.changeMonthTo(n),this.hide()},show:function(){this.date=this.explorer.date,this.year=this.date.get("year"),this.loadMonth(),this.monthSelectNode.setStyle("display","block"),this.hideFun=this.hide.bind(this),document.body.addEvent("mousedown",this.hideFun)},hide:function(){this.monthSelectNode.setStyle("display","none"),document.body.removeEvent("mousedown",this.hideFun)},destroy:function(){}});