MWF.xApplication.CRM.ContactsEdit=new Class({Extends:MWF.xApplication.CRM.Template.PopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"800",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0},initialize:function(e,t,n,i){this.setOptions(i),this.explorer=e,this.app=e.app,this.lp=this.app.lp.contact.contactEdit,this.path="/x_component_CRM/$ContactEdit/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=n||{},this.actions=t,this.province=null},load:function(){this.loadResource(function(){this.appArea=jQuery("body").children(":first"),this.createForm()}.bind(this))},loadResource:function(e){e&&e()},createForm:function(){_self=this,jQuery(_self.appArea).next().attr("style",""),jQuery(_self.appArea).next().attr("class","mask");var r=_self.lp,e='<div class="section-conent">';for(i in r)if(r[i].hasOwnProperty("type")){var t=r[i].type,n=r[i].notEmpty?r[i].notEmpty:"false",a='<input type="text" class="inline-input" name="'+i+'" id="'+i+'" notEmpty="'+n+'" stype="'+t+'">';"textarea"==t&&(a='<textarea rows="6" class="el-textarea__inner"  id="'+i+'" notEmpty="'+n+'" stype="'+t+'"  style="resize: none; min-height: 30.6px;"></textarea>'),"select"!=t&&"hide"!=t||(a='<div class="inline-input" style="display: inline-block;cursor:pointer;"  id="'+i+'" notEmpty="'+n+'" stype="'+t+'" ></div><div class="el-icon-arrow-down el-icon--right" style="margin-left: -20px; display: inline-block;"><img src="/x_component_CRM/$Clue/default/icons/arrow.png"></div>'),"customername"==i&&(a='<input type="text" class="inline-input"  readonly="true" style="background-color: #e2ebf9;cursor:pointer;" name="'+i+'" id="'+i+'" notEmpty="'+n+'" stype="'+t+'">'),"datetime"==t&&(a='<input type="text" class="inline-input" readonly="readonly" name="'+i+'" id="'+i+'" notEmpty="'+n+'" stype="'+t+'">'),e=e+'<div class="conent-inline"><div class="conent-title" lable="'+i+'">'+r[i].text+'</div><div class="conent-value">'+a+"</div></div>"}var o='<div class="section-header"><div class="section-mark" style="border-left-color: rgb(70, 205, 207);"></div> <div data-v-ec8f8850="" class="section-title">基本信息</div></div>'+(e+="</div>")+'<div class="section_button"><div><button class="el-button handle-button el-button-cancle"><span>取消</span></button><button class="el-button handle-button el-button-primary"><span>保存</span></button></div></div>';jQuery(".headMoreImg").notifyMe("left","default","新建联系人","","",o,"notifyEdit",50),jQuery(".conent-value").each(function(e,t){var n=jQuery(t).children().eq(0),i=jQuery(n).attr("stype");if("datetime"==i&&_self.loadTimeContainer(jQuery(n).attr("id")),"openSelect"==i&&jQuery(t).click(function(){_sself=_self.lp,_sself.cancel="关闭",_sself.ok="确定",_self.selectCustomer=new MWF.xApplication.CRM.ContactsEdit.selectForm(null,{},null,{app:_self,container:jQuery("#notifyEdit")[0],lp:_sself,actions:_self.actions,css:{}}),_self.selectCustomer.create()}),"select"==i||"hide"==i){var a=_self.app.lp.contact;for(j in a)if(j==jQuery(n).attr("id")){var o=r[j].value.split(",");if(0<o.length){for(var s='<ul class="el-dropdown-type" style="display: none;" tid="'+jQuery(n).attr("id")+'">',l=0;l<o.length;l++)s=s+'<li class="el-dropdown-menu__item">'+o[l]+"</li>";jQuery(".notify-content").append(s+'<div class="popper__arrow"></div></ul>'),jQuery(n).click(function(){jQuery("[tid='"+jQuery(n).attr("id")+"']").css({left:jQuery(n).offset().left-50,top:jQuery(n).offset().top+30,width:282}),jQuery("[tid='"+jQuery(n).attr("id")+"']").toggle(100)}),jQuery("[tid='"+jQuery(n).attr("id")+"']").children().click(function(){jQuery(n).text(jQuery(this).text()),jQuery("[tid='"+jQuery(n).attr("id")+"']").toggle(100)})}}}}),_self.getAddress(),jQuery(".el-button-cancle").click(function(){setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}),jQuery(".el-button-primary").click(function(){var i=!0;if(jQuery(".inline-input[notempty='true']").each(function(e,t){if(""==jQuery(t).val()&&""==jQuery(t).text()){i=!1;var n=jQuery(t).parent().prev().text()+"不能为空";0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove(),jQuery(t).parent().append('<div class="empError" style="color:#f56c6c;padding: 0;line-height: 1;">'+n+"</div>")}else 0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove()}),i){var e,t=jQuery("[name='province']").val()+"#"+jQuery("[name='city']").val()+"#"+jQuery("[name='district']").val();e={contactsname:jQuery('div[lable="contactsname"]').next().children().eq(0).val(),customerid:jQuery('div[lable="customername"]').next().children().eq(0).attr("cid"),telephone:jQuery('div[lable="telephone"]').next().children().eq(0).val(),cellphone:jQuery('div[lable="cellphone"]').next().children().eq(0).val(),email:jQuery('div[lable="email"]').next().children().eq(0).val(),decision:jQuery('div[lable="decision"]').next().children().eq(0).text(),post:jQuery('div[lable="post"]').next().children().eq(0).val(),sex:jQuery('div[lable="sex"]').next().children().eq(0).text(),province:-1<t.indexOf("0")?"":t,detailaddress:jQuery('div[lable="detailaddress"]').next().children().eq(0).val(),nexttime:jQuery('div[lable="nexttime"]').next().children().eq(0).val(),remark:jQuery('div[lable="remark"]').next().children().eq(0).val()},_self.actions.saveContacts(e,function(e){"success"==e.type&&Showbo.Msg.alert("保存成功!",jQuery("#contact").click()),setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}.bind(_self))}}),jQuery(".notify-content").click(function(e){jQuery(e.target).closest(".inline-input[notempty='true']").length<1&&jQuery(".inline-input[notempty='true']").each(function(e,t){if(""==jQuery(t).val()&&""==jQuery(t).text()){var n=jQuery(t).parent().prev().text()+"不能为空";0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove(),jQuery(t).parent().append('<div class="empError" style="color:#f56c6c;padding: 0;line-height: 1;">'+n+"</div>")}else 0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove()})})},getAddress:function(){var e=this,t=[];o2.Actions.get("x_general_assemble_control").listProvince(function(e){e.data.each(function(e){t.push(e.name)}.bind(this))}.bind(this),null,!1);for(var n="",i=0;i<t.length;i++)n=n+'<option value="'+t[i]+'">'+t[i]+"</option>";var a='<select name="province" class="select-address"><option value="0">所在省</option>'+n+'</select><select name="city" class="select-address city-address"> <option value="0">所在市</option></select> <select class="select-address" name="district"><option value="0">所在区</option></select>';if(jQuery("#province").parent().append(a),jQuery("#province").remove(),null!=e.province){var o=e.province.split("#");1<o.length&&(jQuery("[name='province']").append(new Option(o[0],o[0])),jQuery("[name='province']").val(o[0]),jQuery("[name='city']").append(new Option(o[1],o[1])),jQuery("[name='city']").val(o[1]),jQuery("[name='district']").append(new Option(o[2],o[2])),jQuery("[name='district']").val(o[2]))}jQuery("[name='province']").change(function(){e.getCity(this.value)}),jQuery("[name='city']").change(function(){e.getDistrict(jQuery("[name='province']").val(),this.value)})},getCity:function(e){jQuery("[name='city']").find("option[value!='0']").remove(),jQuery("[name='district']").find("option[value!='0']").remove();var t=jQuery("[name='city']");"所在省"!=e&&o2.Actions.get("x_general_assemble_control").listCity(e,function(e){e.data.each(function(e){jQuery(t).append(new Option(e.name,e.name))})}.bind(this),null,!1)},getDistrict:function(e,t){jQuery("[name='district']").find("option[value!='0']").remove();var n=jQuery("[name='district']");o2.Actions.get("x_general_assemble_control").listDistrict(e,t,function(e){e.data.each(function(e){jQuery(n).append(new Option(e.name,e.name))})},null,!1)},loadTimeContainer:function(e){jQuery("#"+e).ymdateplugin({showTimePanel:!0})},getItemTemplate:function(e){return _self=this,{contactsname:{type:"text",notEmpty:!0,text:e.contactsname,value:this.customerData&&this.customerData.customername?this.customerData.customername:""},customername:{text:e.customername,notEmpty:!0,type:"openSelect"},cellphone:{text:e.cellphone,notEmpty:!0,type:"text"},telephone:{type:"text",text:e.telephone},email:{text:e.email,type:"text"},decision:{type:"select",notEmpty:!0,text:e.decision,value:_self.app.lp.contact.decision.value},post:{text:e.post,type:"text"},sex:{type:"select",text:e.sex,value:_self.app.lp.contact.sex.value},detailaddress:{text:e.detailaddress,type:"text"},nexttime:{text:e.nexttime,notEmpty:!0,attr:{id:"nexttime"},type:"datetime"},remark:{text:e.remark,type:"textarea"}}}}),MWF.xApplication.CRM.ContactsEdit.selectForm=new Class({Extends:MPopupForm,options:{style:"default",width:"700",height:"800",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,maxAction:!0,closeAction:!0,isFull:!1,startTime:null,endTime:null,isWholeday:!1,title:"选择客户",defaultCalendarId:"",callback:function(){console.log("you can do something when is ok")}.bind(this)},load:function(){this.cssPath="/x_component_CRM/$CustomerEdit/"+this.options.style+"/opencss.wcss",this.path="/x_component_CRM/$CustomerEdit/",this.type={},this._loadCss(),this.loadData()},_createTableContent:function(){var e=this.path+"customerSelect.json";this.form=new MWF.xApplication.CRM.ContactsEdit.SelectCustomer(this.formTableArea,null,this.app,this,{templateUrl:e,filterData:{},listPageName:"ListMyParticipate_customer"},{lp:{}}),this.form.load()},_ok:function(e,t){e&&("function"==typeof this.options.callback&&this.options.callback(),this.container.getElement("#customername").setProperty("value",e.customername),this.container.getElement("#customername").setProperty("cid",e.id),this.app.Customer=e,this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode&&this.formAreaNode.destroy(),this.fireEvent("postOk"))},loadData:function(){}}),MWF.xApplication.CRM.ContactsEdit.SelectCustomer=new Class({Extends:MWF.xApplication.CRM.Template.SelectForm,_getCurrentPageData:function(t,e,n,i){this.category=this.options.category;e||(e=10),n||(n=1);this.items.length&&this.items[this.items.length-1].data.id;var a=this.options.filterData||{};i&&(a={key:i}),this.actions.ListMyParticipate_customer(n,e,a,function(e){t&&t(e)}.bind(this))}});