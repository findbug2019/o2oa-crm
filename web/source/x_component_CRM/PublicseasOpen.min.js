MWF.xApplication.CRM.AddressExplorer=null,MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.CRM.PublicseasOpen=new Class({Extends:MWF.xApplication.CRM.Template.PopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0},initialize:function(t,e,i,s){this.setOptions(s),this.explorer=t,this.app=t.app,this.lp=this.app.lp.publicseas.customerEdit,this.path="/x_component_CRM/$ClueEdit/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=i||{},this.actions=e,this.configData=[]},load:function(){(that=this).loadResource(function(){this.appArea=jQuery("body").children(":first"),this.createForm(),this.loadEvent()}.bind(this))},loadResource:function(t){t&&t()},createForm:function(){var t=(that=this).options.openName,i=!1,e="";this.actions.isManager(function(t){if("success"==t.type){var e=t.data;void 0===e.isManager||(i=e.isManager)}}.bind(this)),i&&(e='<li class="el-dropdown-menu__item">分配</li><li class="el-dropdown-menu__item">删除</li>');var s='<ul class="el-dropdown-menu"><li class="el-dropdown-menu__item">领取</li>'+e+'<div class="popper__arrow"></div></ul>',a=that.getNotifyMax(),n=this.options.openStyle?this.options.openStyle:this.xxx;jQuery(".headMoreImg").notifyMe("right","default",t,'<div class = "headBottonDiv"><div class="headMoreBottonDiv"><span>更多</span><img class="headMoreImg" src="/x_component_CRM/$Clue/default/icons/arrow.png"></div></div>',s,"",a,500,n),that.createContentHtml(a)},getNotifyMax:function(){var t="notify",a=0;return this.options.openType&&"single"==this.options.openType||(jQuery(".notify").each(function(t,e){var i=jQuery(e).attr("id"),s=0;0<i.indexOf("_")?(s=parseInt(i.split("_")[1]),a<s&&(a=s)):0==a&&(a=1)}),0<a&&(t=t+"_"+a)),t},createContentHtml:function(t){(that=this).sectionArea=jQuery("body")[0].getElement("#"+t),this.actions.getCustomerInfo(this.options.openId,function(t){var e=t.data,i=""==e.owneruser||void 0===e.owneruser?"--":e.owneruser.split("@")[0],s="<div class = 'briefdiv'><div class='div-inline'><div class='div-title'>客户级别</div><div class='div-value'>"+e.level+"</div></div><div class='div-inline'><div class='div-title'>成交状态</div><div class='div-value'>"+e.dealstatus+"</div></div><div class='div-inline'><div class='div-title'>负责人</div><div class='div-value'>"+i+"</div></div><div class='div-inline'><div class='div-title'>更新时间</div><div class='div-value'>"+e.updateTime+"</div></div></div>";this.sectionArea.getElement(".notify-content").set("html",s+"<div class='tabPanel'><div class='hit'>跟进记录</div><div style='width:30px'></div><div>基本信息</div><div style='width:30px'></div><div>联系人</div><div style='width:30px'></div><div>相关团队</div><div style='width:30px'></div><div style='display:none'>商机</div><div style='display:none;width:30px'></div><div>附件</div><div style='width:30px'></div><div>操作记录</div></div><div class='panes'><div class='pane' id='tab-follow' style='display:block;'><p>First tab content</p></div><div></div><div class='pane' id='tab-basicinfo'><p>Secend tab content</p></div><div></div><div class='pane' id='tab-contacts'><p>contacts tab content</p></div><div></div><div class='pane' id='tab-team'><p>team tab content</p></div><div></div><div class='pane' id='tab-business'><p>business tab content</p></div><div></div><div class='pane' id='tab-att'><p>Third tab content</p></div><div></div><div class='pane' id='tab-options'><p>Four tab content</p></div></div>");var a=this.sectionArea.getSize();this.sectionArea.getElement(".panes").setStyles({height:a.y-250+"px"});this.sectionArea.getElement("#tab-follow").set("html",'<div class="log-cont"><div class="log-inner1"><div class="log-inner2"><div class="log-items"><div class="load"><button  type="button" class="el-button el-button--text"><span>没有更多了</span></button></div></div><div class="empty-mask" style="display: none;margin-bottom:180px;"><div class="empty-content"><img src="/x_component_CRM/$Template/empty.png" class="empty-icon"> <p class="empty-text">没有找到数据</p></div></div></div><div class="el-loading-mask" style="display: none;"><div class="el-loading-spinner"><svg viewBox="25 25 50 50" class="circular"><circle cx="50" cy="50" r="20" fill="none" class="path"></circle></svg></div></div></div></div>'),that.loadTimeContainer("stime"),that.loadRecord()}.bind(this))},createTypeHtml:function(){var t=jQuery(this.sectionArea).find(".hit").text();"基本信息"==t&&this.getPublicseasInfo(),"联系人"==t&&this.loadContacts(),"相关团队"==t&&this.loadTeam(),"商机"==t&&this.loadBusiness(),"附件"==t&&this.loadAttachment(),"操作记录"==t&&this.loadOptions()},loadTimeContainer:function(t){jQuery("#"+t).ymdateplugin({showTimePanel:!0})},getPublicseasInfo:function(){(_self=this).actions.getCustomerInfo(this.options.openId,function(t){var e=t.data,s=_self.getItemTemplate(_self.lp),a='<div class="section-conent">';for(i in s)a=a+'<div class="conent-inline"><div class="conent-title">'+s[i].text+'</div><div class="conent-value">'+(void 0===e[i]?"":e[i])+"</div></div>";a+="</div>",jQuery(_self.sectionArea).find("#tab-basicinfo").html('<div class="section-header"><div class="section-mark" style="border-left-color: rgb(70, 205, 207);"></div> <div data-v-ec8f8850="" class="section-title">基本信息</div></div>'+a)}.bind(this))},loadAttachment:function(){that=this;var t='<div class="rc-cont">';t+='<div  class="el-table el-table--fit el-table--striped el-table--enable-row-hover" header-align="center" style="width: 100%; border: 1px solid rgb(230, 230, 230); height: 500px;" align="center"><div class="el-table__header-wrapper"><table class="el-table__header" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><thead class="has-gutter"><tr class=""><th colspan="1" rowspan="1" class="el-table_3_column_27     is-leaf" style="width: 40%;height:40px;"><div class="cell">附件名称</div></th><th colspan="1" rowspan="1" class="el-table_3_column_28     is-leaf" style="width: 10%;"><div class="cell">附件大小</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 20%;"><div class="cell">上传人</div></th><th colspan="1" rowspan="1" class="el-table_3_column_30     is-leaf" style="width: 20%;"><div class="cell">上传时间</div></th></tr></thead></table></div><div class="el-table__body-wrapper is-scrolling-none" style="height: 450px;"><table class="el-table__body" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><tbody></tbody></table><div class="el-table__empty-block" style="width: 100%;"><span class="el-table__empty-text">暂无数据</span></div></div></div></div>',jQuery(that.sectionArea).find("#tab-att").html(t),jQuery(that.sectionArea).find("#afile").change(function(t){var e=jQuery(that.sectionArea).find("#afile")[0].files;jQuery(e).each(function(t,e){e.name;var i=new FormData;i.append("fileName",e.name),i.append("file",e),that.actions.updateAttachment("att",that.options.openId,"customer",i,e,function(t){"success"==t.type&&that.getAttachment()}.bind(that))})}),that.getAttachment()},getAttachment:function(){(that=this).actions.getAttachment(this.options.openId,function(t){if("success"==t.type){var e=t.data,s="";for(i in e)if(i<e.length){var a=e[i],n=a.length/1024,o=a.lastUpdatePerson;o=o.split("@")[0],s=s+'<tr><td style="width: 40%;height:40px;" class="aname" aid="'+a.id+'" wcrm="'+a.wcrm+'">'+a.name+'</td><td style="width: 10%;">'+that.toDecimal(n)+'kb</td><td style="width: 20%;">'+o+'</td><td style="width: 20%;">'+a.updateTime+"</td></tr>"}""!=s&&(jQuery(that.sectionArea).find(".el-table__body").children().html(s),jQuery(that.sectionArea).find(".el-table__empty-block").hide(),jQuery(that.sectionArea).find(".aname").click(function(){var t=that.actions.action.address+"/jaxrs/attachment/download/"+jQuery(this).attr("aid")+"/work/"+jQuery(this).attr("wcrm");window.open(t)}))}}.bind(that))},loadContacts:function(){that=this;var t='<div class="rc-cont">';t+='<div  class="el-table el-table--fit el-table--striped el-table--enable-row-hover" header-align="center" style="width: 100%; border: 1px solid rgb(230, 230, 230); height: 500px;" align="center"><div class="el-table__header-wrapper"><table class="el-table__header" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><thead class="has-gutter"><tr class=""><th colspan="1" rowspan="1" class="el-table_3_column_27     is-leaf" style="width: 33%;height:40px;"><div class="cell">姓名</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 34%;"><div class="cell">手机</div></th><th colspan="1" rowspan="1" class="el-table_3_column_26     is-leaf" style="width: 33%;"><div class="cell">职务</div></th></tr></thead></table></div><div class="el-table__body-wrapper is-scrolling-none" style="height: 450px;"><table class="el-table__body" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><tbody></tbody></table><div class="el-table__empty-block" style="width: 100%;"><span class="el-table__empty-text">暂无数据</span></div></div></div></div>',jQuery(that.sectionArea).find("#tab-contacts").html(t),this.actions.getContacts(this.options.openId,function(t){if("success"==t.type){var e=t.data,s="";for(i in e)if(i<e.length){var a=e[i];s=s+'<tr><td style="width: 34%;height:40px;" class="aname" aid="'+a.id+'">'+a.contactsname+'</td><td style="width: 33%;">'+a.cellphone+'</td><td style="width: 33%;">'+a.post+"</td></tr>"}""!=s&&(jQuery(that.sectionArea).find(".el-table__body").children().html(s),jQuery(that.sectionArea).find(".el-table__empty-block").hide())}}.bind(that)),jQuery(that.sectionArea).find("#tab-contacts").find(".rc-head-item").click(function(){that.contactsCreate()}),jQuery(that.sectionArea).find("#tab-contacts").find(".aname").click(function(){})},loadTeam:function(){that=this;var t='<div class="rc-cont">';t+='<div  class="el-table el-table--fit el-table--striped el-table--enable-row-hover" header-align="center" style="width: 100%; border: 1px solid rgb(230, 230, 230); height: 500px;" align="center"><div class="el-table__header-wrapper"><table class="el-table__header" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><thead class="has-gutter"><tr class=""><th colspan="1" rowspan="1" class="el-table_3_column_27"><div class="cell"><input class="inp-cbx" id="all" type="checkbox" style="display: none;"/><label class="cbx cbxx" for="all"><span><svg width="12px" height="10px"><use xlink:href="#check"></use></svg></span><span></span></label></div></th><th colspan="1" rowspan="1" class="el-table_3_column_27     is-leaf" style="width: 30%;height:40px;"><div class="cell">姓名</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 20%;"><div class="cell">职位</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 20%;"><div class="cell">团队角色</div></th><th colspan="1" rowspan="1" class="el-table_3_column_26     is-leaf" style="width: 20%;"><div class="cell">权限</div></th></tr></thead></table></div><svg class="inline-svg"><symbol id="check" viewbox="0 0 12 10"><polyline points="1.5 6 4.5 9 10.5 1" ></polyline></symbol></svg><div class="el-table__body-wrapper is-scrolling-none" style="height: 450px;"><table class="el-table__body" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><tbody></tbody></table><div class="el-table__empty-block" style="width: 100%;"><span class="el-table__empty-text">暂无数据</span></div></div></div></div>',jQuery(that.sectionArea).find("#tab-team").html(t),this.actions.getTeamMemberListById(this.options.openId,function(t){if("success"==t.type){var e=t.data,s="";for(i in e)if(i<e.length){var a=e[i],n=0<a.units.length?a.units[0].split("@")[0]:"",o="all"+i,l='<div class="cell"><input class="inp-cbx" id="'+o+'" type="checkbox" style="display: none;"/><label class="cbx cbxx" for="'+o+'"><span><svg width="12px" height="10px"><use xlink:href="#check"></use></svg></span><span></span></label></div>';a.teamRole&&"负责人"==a.teamRole&&(l='<div class="cell"><input class="inp-cbx" id="'+o+'" type="checkbox" style="display: none;"/><label class="cbx" for="xx"><span style="background: #e6e6e6;"><svg width="12px" height="0px"><use xlink:href="#check"></use></svg></span><span></span></label></div>'),a.teamRole&&""!=a.teamRole&&(s=s+'<tr><td style="width: 10%;height:40px;">'+l+'</td><td style="width: 30%;" class="aname" aid="'+a.person.distinguishedName+'">'+a.person.name+'</td><td style="width: 20%;">'+n+'</td><td style="width: 20%;">'+a.teamRole+'</td><td style="width: 20%;">'+a.dispaly_permission+"</td></tr>")}""!=s&&(jQuery(that.sectionArea).find(".el-table__body").children().html(s),jQuery(that.sectionArea).find(".el-table__empty-block").hide())}}.bind(that)),jQuery("[for='all']").click(function(){var t=jQuery(that.sectionArea).find(".cbxx").not("[for='all']");jQuery(this).prev().is(":checked")?t.each(function(t,e){jQuery(e).prev().prop("checked",!1)}):t.each(function(t,e){jQuery(e).prev().prop("checked",!0)})})},loadBusiness:function(){that=this;var t='<div class="rc-cont">';t+='<div  class="el-table el-table--fit el-table--striped el-table--enable-row-hover" header-align="center" style="width: 100%; border: 1px solid rgb(230, 230, 230); height: 500px;" align="center"><div class="el-table__header-wrapper"><table class="el-table__header" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><thead class="has-gutter"><tr class=""><th colspan="1" rowspan="1" class="el-table_3_column_27     is-leaf" style="width: 30%;height:40px;"><div class="cell">商机名称</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 20%;"><div class="cell">商品金额</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 30%;"><div class="cell">客户名称</div></th><th colspan="1" rowspan="1" class="el-table_3_column_29     is-leaf" style="width: 20%;"><div class="cell">商机状态组</div></th><th colspan="1" rowspan="1" class="el-table_3_column_26     is-leaf" style="width: 20%;"><div class="cell">状态</div></th></tr></thead></table></div><div class="el-table__body-wrapper is-scrolling-none" style="height: 450px;"><table class="el-table__body" style="width: 100%;" cellspacing="0" cellpadding="0" border="0"><tbody></tbody></table><div class="el-table__empty-block" style="width: 100%;"><span class="el-table__empty-text">暂无数据</span></div></div></div></div>',jQuery(that.sectionArea).find("#tab-business").html(t),this.actions.getOpportunityListByCustomerId(this.options.openId,function(t){if("success"==t.type){var e=t.data,s="";for(i in e)if(i<e.length){var a=e[i];s=s+'<tr><td style="width: 30%;height:40px;" class="aname" aid="'+a.id+'">'+a.opportunityname+'</td><td style="width: 20%;">'+a.money+'</td><td style="width: 30%;">'+a.customer.customername+'</td><td style="width: 20%;">'+a.opportunityType.opportunitytypename+'</td><td style="width: 20%;">'+a.opportunityStatus.opportunitystatusname+"</td></tr>"}""!=s&&(jQuery(that.sectionArea).find(".el-table__body").children().html(s),jQuery(that.sectionArea).find(".el-table__empty-block").hide())}}.bind(that)),jQuery(that.sectionArea).find("#tab-business").find(".rc-head-item").click(function(){that.businessCreate()}),jQuery(that.sectionArea).find("#tab-business").find(".aname").click(function(){})},loadOptions:function(){that=this;jQuery(that.sectionArea).find("#tab-options").html('<div class="rc-cont"><div class="empty-mask" style="display:none;margin-bottom:180px;"><div class="empty-content" style="margin-top:0px;"><img src="/x_component_CRM/$Template/empty.png" class="empty-icon"> <p class="empty-text">没有找到数据</p></div></div></div>'),this.actions.getOptionsRecord(this.options.openId,function(t){if("success"==t.type){var e=t.data;jQuery(that.sectionArea).find(".rc-cont").find(".vux-flexbox").remove();var s="";for(i in e)if(i<e.length){var a=e[i],n="/x_component_CRM/$Template/portrait.png";a.hasOwnProperty("ICONBase64")&&""!=a.ICONBase64&&(n="data:image/png;base64,"+a.ICONBase64);var o=a.updateTime;s=s+'<div class="vux-flexbox ha-cont vux-flex-row" style="justify-content: flex-start; align-items: stretch;"><div class="ha-week">'+a.DateCN+'</div><div class="ha-circle"></div> <div class="ha-time">'+o.substring(11,16)+'</div><div class="div-photo ha-img xs-photo-parent--relative" style="background-image: url(&quot;'+n+'&quot;);" lazy="error"><div class="photo-wrap"></div></div><div class="ha-name">'+a.person.name+'</div><div class="ha-content">'+a.content+'</div><div class="ha-line"></div></div>'}""!=s&&jQuery(that.sectionArea).find(".rc-cont").append(s),e.length<1&&jQuery(that.sectionArea).find(".empty-mask").show()}}.bind(this))},receiveCustomer:function(){_self=this;Showbo.Msg.confirm("提示","确定要领取此客户吗？领取后将在公海移除。",function(){_self.confirmReceiveCustomer()},function(){}),jQuery(".handle-item-content").click(function(){jQuery(".ct").find(".el-dropdown-confirm").toggle(100)})},confirmReceiveCustomer:function(){this.actions.receiveCustomer(this.options.openId,function(t){"success"==t.type&&Showbo.Msg.alert("操作成功!",jQuery("#publicseas").click())}.bind(this))},distributeCustomer:function(){_self=this;Showbo.Msg.confirm("公海分配",'<div  class="vux-flexbox handle-item vux-flex-row" style="align-items: stretch;padding: 30px 20px 0px 20px;line-height:30px;"><div class="handle-item-name" style="margin-top: 8px;width:130px;">分配给：</div><div class="el-select handle-item-content" style="margin-top: 8px;"><div class="se-select-name" id="selectName" style="display: inline-block;">+点击选择</div><div id="selectId" style="display:none;"></div></div></div><div  class="vux-flexbox handle-item vux-flex-row" style="align-items: stretch;padding: 10px 20px 80px 20px;line-height:30px;"></div></div>',function(){var t=!0;if(""==jQuery("#selectId").text()&&(t=!1,Showbo.Msg.alert("请选择负责人!")),t){var e;e={distinguishName:jQuery("#selectId").text()},_self.actions.distributeCustomer(_self.options.openId,e,function(t){"success"==t.type&&Showbo.Msg.alert("操作成功!",jQuery("#publicseas").click()),setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}.bind(_self))}},function(){}),jQuery(".ct").find(".se-select-name").click(function(){_self.selectPerson(jQuery(_self.appArea)[0],"selectName","selectId",0)})},loadEvent:function(){that=this,jQuery(that.sectionArea).find(".tabPanel div").click(function(){jQuery(this).addClass("hit").siblings().removeClass("hit"),jQuery(that.sectionArea).find(".panes>div:eq("+jQuery(this).index()+")").show().siblings().hide(),that.createTypeHtml()}),jQuery(that.sectionArea).find(".headMoreBottonDiv").click(function(){jQuery(that.sectionArea).find(".el-dropdown-menu").toggle(100)}),jQuery(that.sectionArea).find(".el-dropdown-menu__item").click(function(){"分配"==jQuery(this).text()&&that.distributeCustomer(),"领取"==jQuery(this).text()&&that.receiveCustomer(),"删除"==jQuery(this).text()&&that.deleteCustomer(),"recordType"==jQuery(this).parent().attr("tid")&&(jQuery(that.sectionArea).find(".se-select-name").text(jQuery(this).text()),jQuery(this).parent().toggle(100))}),jQuery(that.sectionArea).find("#bar-file").change(function(t){var e=t.target.files;if(jQuery(that.sectionArea).find(".fileList").empty(),e&&0<e.length){for(var i='<div class="fileList">',s=0;s<e.length;s++){var a=e[s],n=a.size/1024;i=i+'<div class="fileItem"><div class="fname">'+a.name+'</div><div class="fsize">'+that.toDecimal(n)+'kb</div><div class="ftime">'+that.getFormateTime(new Date)+"</div></div>"}i+="</div>",jQuery(that.sectionArea).find(".mix-container").append(i)}}),jQuery(that.sectionArea).find(".el-dropdown-selfdefine").click(function(){jQuery(that.sectionArea).find("[tid='recordType']").toggle(100)})},loadRecord:function(){(that=this).actions.getRecord(this.options.openId,function(t){if("success"==t.type){var e=t.data;jQuery(that.sectionArea).find(".fl-c").remove();var s="";for(i in e)if(i<e.length){var a=e[i],n="/x_component_CRM/$Template/portrait.png";a.hasOwnProperty("ICONBase64")&&""!=a.ICONBase64&&(n="data:image/png;base64,"+a.ICONBase64);var o="";if(0<a.attachmentListPreview.length&&(o+='<div class="vux-flexbox fl-b-images vux-flex-row" style="flex-wrap: wrap;"></div>'),0<a.attachmentList.length){o+='<div class="fl-b-files">';var l=a.attachmentList;for(j in l)if(j<l.length){var d=l[j];o=o+'<div class="vux-flexbox cell vux-flex-row"><img  src="/x_component_CRM/$Record/default/icons/att.png" class="cell-head"> <div class="cell-body">'+d.name+'<span  style="color: rgb(204, 204, 204);">（'+that.toDecimal(d.length)+'KB）</span></div><button  type="button" class="el-button el-button--primary aname" aid="'+d.id+'" wcrm="'+d.wcrm+'"><img  src="/x_component_CRM/$Record/default/icons/down.png" style="margin-bottom:-3px;"><span>下载</span></button></div>'}o+="</div>"}s=s+'<div class="fl-c"><div class="vux-flexbox fl-h vux-flex-row"><div class="div-photo fl-h-img"  style="background-image: url(&quot;'+n+'&quot;);" lazy="loaded"></div> <div class="fl-h-b"><div class="fl-h-name">'+a.person.name+'</div><div class="fl-h-time">'+a.updateTime+'</div></div></div><div class="fl-b"><div class="fl-b-content">'+a.content+"</div>"+o+'<div class="follow"><span class="follow-info">'+a.category+'</span></div></div><div  class="full-container" style="display: none;"></div></div>'}""!=s&&jQuery(that.sectionArea).find(".load").before(s),e.length<1?(jQuery(that.sectionArea).find(".load").hide(),jQuery(that.sectionArea).find(".empty-mask").show()):jQuery(that.sectionArea).find(".empty-mask").hide(),jQuery(".aname").click(function(){var t="http://172.16.92.55:20020/x_wcrm_assemble_control/jaxrs/attachment/download/"+jQuery(this).attr("aid")+"/work/"+jQuery(this).attr("wcrm");window.open(t)})}}.bind(this))},open:function(t){this.fireEvent("queryOpen"),this._open(),this.fireEvent("postOpen")},create:function(){this.fireEvent("queryCreate"),this.isNew=!0,this._open(),this.fireEvent("postCreate")},edit:function(){this.fireEvent("queryEdit"),this.isEdited=!0,this._open(),this.fireEvent("postEdit")},_open:function(){if(this.options.hasMask&&(this.formMaskNode=new Element("div.formMaskNode",{styles:this.css.formMaskNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()},click:function(t){t.stopPropagation()}}}).inject(this.container||this.app.content)),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.createFormNode(),this.formAreaNode.inject(this.formMaskNode||this.container||this.app.content,"after"),this.formAreaNode.fade("in"),this.setFormNodeSize(),this.setFormNodeSizeFun=this.setFormNodeSize.bind(this),this.app&&this.app.addEvent("resize",this.setFormNodeSizeFun),this.options.draggable&&this.formTopNode){var t=(this.container||this.app.content).getSize(),e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})}},deleteCustomer:function(){_self=this,Showbo.Msg.confirm("提示","确定要删除此公海客户吗?",function(){_self.confirmDelCustomer()},function(){})},confirmDelCustomer:function(){this.actions.deleteCustomer(this.options.openId,function(t){"success"==t.type&&(this.isCurrentItem,Showbo.Msg.alert("删除成功!",jQuery("#publicseas").click()))}.bind(this))},createFormNode:function(){this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.formAreaNode),this.options.hasTop&&this.createTopNode(),this.options.hasIcon&&(this.formIconNode=new Element("div.formIconNode",{styles:this.isNew?this.css.formNewNode:this.css.formIconNode}).inject(this.formNode)),this.createContent(),this.options.hasBottom&&this.createBottomNode(),this._setCustom(),this.options.hasScroll&&MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.formTableContainer,{indent:!1,style:"default",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){}})}.bind(this))},createContent:function(){this.formContentNode=new Element("div.formContentNode",{styles:this.css.formContentNode}).inject(this.formNode),this.formTableContainer=new Element("div.formTableContainer",{styles:this.css.formTableContainer}).inject(this.formContentNode),this.formTableArea=new Element("div.formTableArea",{styles:this.css.formTableArea,text:"loading..."}).inject(this.formTableContainer),this._createTableContent()},createBottomNode:function(){this.formBottomNode=new Element("div.formBottomNode",{styles:this.css.formBottomNode}).inject(this.formNode),this._createBottomContent()},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title+(this.data.title?"-"+this.data.title:"")}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))),this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())},_createTopContent:function(){},_createTableContent:function(){this.loadFormData()},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.actionCancel}).inject(this.formBottomNode),(this.options.isNew||this.options.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.actionConfirm}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},loadFormData:function(){this.loadForm()},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,",",!0,!1,!0);e&&this._ok(e,function(t){"error"==t.type?this.app&&this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postOk"))}.bind(this))},loadForm:function(){(_self=this).form=new MForm(this.formTableArea,this.data,{style:"default",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app,this.css);var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>",e=this.form.itemTemplate;for(i in e)t=t+"<tr>   <td styles='formTableTitle'><span lable='"+i+"'>"+e[i].text+"</td>   <td styles='formTableValue' item='"+i+"'></td></tr>";t+="</table>",this.formTableArea.set("html",t),this.form.load(),this.isNew||this.actions.geCustomerInfo(this.options.openId,function(t){var e=t.data,i=this.formTableArea.getElements("span");for(j in i)if(j<i.length&&null!=i[j].get("name")){var s=i[j].get("name");for(var a in e)a==s&&i[j].set("text",e[a])}}.bind(this)),this.formTableArea.getElements("textarea").setStyles({height:"100px",overflow:"auto",color:"#666666"}),this.formTableArea.getElements("input").setStyles({color:"#666666"})},loadMap:function(){(_self=this).mapDiv=jQuery("#setMap")[0],jQuery(".section-conent").css("height","700px"),this.mapDiv&&this.mapDiv.empty(),this.addressModule&&delete this.addressModule,MWF.xDesktop.requireApp("CRM","AddressExplorer",function(){this.addressModule=new MWF.xApplication.CRM.AddressExplorer(this.mapDiv,this,this.actions,{}),this.addressModule.load()}.bind(this))},getItemTemplate:function(t){return _self=this,{customername:{text:t.customername,type:"text",notEmpty:!0,value:this.customerData&&this.customerData.customername?this.customerData.customername:""},level:{type:"select",text:t.level,value:this.app.lp.customer.level.value},industry:{type:"select",text:t.industry,value:this.app.lp.customer.industry.value},source:{type:"select",text:t.source,value:this.app.lp.customer.source.value},telephone:{type:"text",text:t.telephone,value:this.app.lp.clue.level.value},website:{text:t.website,type:"text"},nexttime:{text:t.nexttime,attr:{id:"nexttime"},type:"datetime"},cellphone:{text:t.cellphone,type:"text"},detailaddress:{text:t.detailaddress,type:"text"},remark:{text:t.remark,type:"textarea"},location:{text:t.location,type:"map"}}},getContactTemplate:function(t){return _self=this,{contactsname:{text:t.contactsname,type:"text",notEmpty:!0},customername:{text:t.customername,type:"readonly",notEmpty:!0},telephone:{type:"text",text:t.telephone},cellphone:{text:t.cellphone,type:"text"},email:{type:"text",text:t.email},decision:{type:"select",text:t.decision,value:this.app.lp.contact.decision.value},post:{text:t.post,type:"text"},sex:{type:"select",text:t.sex,value:this.app.lp.contact.sex.value},detailaddress:{text:t.detailaddress,type:"text"},nexttime:{text:t.nexttime,attr:{id:"nexttime"},type:"datetime"},remark:{text:t.remark,type:"textarea"}}},selectPerson:function(t,e,a,i){var s={type:"",types:["person"],values:this.configData,count:i,zIndex:5e4,onComplete:function(t){MWF.require("MWF.widget.O2Identity",function(){var i=[],s=[];this.configData=[],this.process=null,t.each(function(t){if("i"==t.data.distinguishedName.split("@").getLast().toLowerCase()){new MWF.widget.O2Identity(t.data,it.form.getItem("invitePersonList").container,{style:"room"});i.push(t.data.distinguishedName)}else{i.push(t.data.name),s.push(t.data.distinguishedName);var e={name:t.data.name,distinguishedName:t.data.distinguishedName,employee:t.data.employee};this.configData.push(e)}}.bind(this)),0==t.length?document.getElementById(e).innerHTML="+点击选择":(document.getElementById(e).innerHTML=i.join(","),""!=a&&(document.getElementById(a).innerHTML=s.join(",")))}.bind(this))}.bind(this)};new MWF.O2Selector(t,s)},getFormateTime:function(t){_self=this;var e=new Date(t);return e.getFullYear()+"-"+_self.checkTime(e.getMonth()+1)+"-"+_self.checkTime(e.getDate())+" "+_self.checkTime(e.getHours())+":"+_self.checkTime(e.getMinutes())+":"+_self.checkTime(e.getSeconds())},checkTime:function(t){return t<10&&(t="0"+t),t},toDecimal:function(t){if(""==t)return"";var e=parseFloat(t);return isNaN(e)?t:e=Math.round(100*t)/100},createCustomBottom:function(){this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.actionConfirm}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))},_ok:function(data,callback){var saveDataStr="";for(i in this.data)saveDataStr=saveDataStr+"'"+i+"':'"+this.data[i]+"',";saveDataStr="'{"+saveDataStr.replace(/'/g,'"')+"}'";var saveData=eval("("+saveDataStr.substring(1,saveDataStr.length-1)+")");this.app.createShade(),this.actions.saveClue(saveData,function(t){this.app.destroyShade(),this.app.notice(this.lp.saveSuccess,"success"),this.close(),this.fireEvent("reloadView",t)}.bind(this),function(t,e,i){this.app.showErrorMessage(t,e,i),this.app.destroyShade()}.bind(this))}});