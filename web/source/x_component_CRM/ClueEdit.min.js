MWF.xApplication.CRM.ClueEdit=new Class({Extends:MWF.xApplication.CRM.Template.PopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",top:0,left:0,hasTop:!0,hasIcon:!1,hasBottom:!0,title:"",draggable:!1,closeAction:!0},initialize:function(e,t,n,i){this.setOptions(i),this.explorer=e,this.app=e.app,this.lp=this.app.lp.clue.clueEdit,this.path="/x_component_CRM/$ClueEdit/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.options.title=this.lp.title,this.data=n||{},this.actions=t,this.province=null},load:function(){this.loadResource(function(){this.appArea=jQuery("body").children(":first"),this.createForm()}.bind(this))},loadResource:function(e){e&&e()},createForm:function(){_self=this,jQuery(_self.appArea).next().attr("style",""),jQuery(_self.appArea).next().attr("class","mask");var o=_self.lp,e='<div class="section-conent">';for(i in o){var t=o[i].type,n=o[i].notEmpty?o[i].notEmpty:"false",a='<input type="text" class="inline-input" name="'+i+'" id="'+i+'" notEmpty="'+n+'" stype="'+t+'">';"textarea"==t&&(a='<textarea rows="6" class="el-textarea__inner"  id="'+i+'" notEmpty="'+n+'" stype="'+t+'"  style="resize: none; min-height: 30.6px;"></textarea>'),"select"==t&&(a='<div class="inline-input" style="display: inline-block;cursor:pointer;"  id="'+i+'" notEmpty="'+n+'" stype="'+t+'" ></div><div class="el-icon-arrow-down el-icon--right" style="margin-left: -20px;height:34px; display: inline-block;"><img src="/x_component_CRM/$Clue/default/icons/arrow.png"></div>'),"datetime"==t&&(a='<input type="text" class="inline-input" readonly="readonly" name="'+i+'" id="'+i+'" notEmpty="'+n+'" stype="'+t+'">'),e=e+'<div class="conent-inline"><div class="conent-title" lable="'+i+'">'+o[i].text+'</div><div class="conent-value">'+a+"</div></div>"}var r='<div class="section-header"><div class="section-mark" style="border-left-color: rgb(70, 205, 207);"></div> <div data-v-ec8f8850="" class="section-title">基本信息</div></div>'+(e+="</div>")+'<div class="section_button"><div><button class="el-button handle-button el-button-cancle"><span>取消</span></button><button class="el-button handle-button el-button-primary"><span>保存</span></button></div></div>';jQuery(".headMoreImg").notifyMe("left","default","新建线索","","",r,"notifyEdit",50),jQuery(".conent-value").each(function(e,t){var n=jQuery(t).children().eq(0),i=jQuery(n).attr("stype");if("datetime"==i&&_self.loadTimeContainer(jQuery(n).attr("id")),"select"==i){var a=_self.app.lp.clue;for(j in a)if(j==jQuery(n).attr("id")){var r=o[j].value.split(",");if(0<r.length){for(var l='<ul class="el-dropdown-type" style="display: none;" tid="'+jQuery(n).attr("id")+'">',s=0;s<r.length;s++)l=l+'<li class="el-dropdown-menu__item">'+r[s]+"</li>";jQuery(".notify-content").append(l+'<div class="popper__arrow"></div></ul>'),jQuery(n).click(function(){jQuery("[tid='"+jQuery(n).attr("id")+"']").css({left:jQuery(n).offset().left-50,top:jQuery(n).offset().top+30,width:282}),jQuery("[tid='"+jQuery(n).attr("id")+"']").toggle(100)}),jQuery("[tid='"+jQuery(n).attr("id")+"']").children().click(function(){jQuery(n).text(jQuery(this).text()),jQuery("[tid='"+jQuery(n).attr("id")+"']").toggle(100)})}}}}),_self.getAddress(),jQuery(".el-button-cancle").click(function(){setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}),jQuery(".el-button-primary").click(function(){var i=!0;if(jQuery(".inline-input[notempty='true']").each(function(e,t){if(""==jQuery(t).val()&&""==jQuery(t).text()){i=!1;var n=jQuery(t).parent().prev().text()+"不能为空";0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove(),jQuery(t).parent().append('<div class="empError" style="color:#f56c6c;padding: 0;line-height: 1;">'+n+"</div>")}else 0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove()}),i){var e,t=jQuery("[name='province']").val()+"#"+jQuery("[name='city']").val()+"#"+jQuery("[name='district']").val();e={name:jQuery('div[lable="name"]').next().children().eq(0).val(),source:jQuery('div[lable="source"]').next().children().eq(0).text(),telephone:jQuery('div[lable="telephone"]').next().children().eq(0).val(),cellphone:jQuery('div[lable="cellphone"]').next().children().eq(0).val(),industry:jQuery('div[lable="industry"]').next().children().eq(0).text(),level:jQuery('div[lable="level"]').next().children().eq(0).text(),province:-1<t.indexOf("0")?"":t,address:jQuery('div[lable="address"]').next().children().eq(0).val(),nexttime:jQuery('div[lable="nexttime"]').next().children().eq(0).val(),remark:jQuery('div[lable="remark"]').next().children().eq(0).val()},_self.actions.saveClue(e,function(e){"success"==e.type&&Showbo.Msg.alert("保存成功!",jQuery("#clue").click()),setTimeout(function(){jQuery("#notifyEdit").remove(),0<jQuery(".mask").length&&(jQuery(".mask").attr("style","left: 0px; top: 0px; width: 100%; overflow: hidden; position: absolute; z-index: 500000; background-color: rgb(255, 255, 255)"),jQuery(".mask").attr("class",""))},200)}.bind(_self))}}),jQuery(".notify-content").click(function(e){jQuery(e.target).closest(".inline-input[notempty='true']").length<1&&jQuery(".inline-input[notempty='true']").each(function(e,t){if(""==jQuery(t).val()&&""==jQuery(t).text()){var n=jQuery(t).parent().prev().text()+"不能为空";0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove(),jQuery(t).parent().append('<div class="empError" style="color:#f56c6c;padding: 0;line-height: 1;">'+n+"</div>")}else 0<jQuery(t).nextAll(".empError").length&&jQuery(t).nextAll(".empError").remove()})})},getAddress:function(){var e=this,t=[];o2.Actions.get("x_general_assemble_control").listProvince(function(e){e.data.each(function(e){t.push(e.name)}.bind(this))}.bind(this),null,!1);for(var n="",i=0;i<t.length;i++)n=n+'<option value="'+t[i]+'">'+t[i]+"</option>";var a='<select name="province" class="select-address"><option value="0">所在省</option>'+n+'</select><select name="city" class="select-address city-address"> <option value="0">所在市</option></select> <select class="select-address" name="district"><option value="0">所在区</option></select>';if(jQuery("#province").parent().append(a),jQuery("#province").remove(),null!=e.province){var r=e.province.split("#");1<r.length&&(jQuery("[name='province']").append(new Option(r[0],r[0])),jQuery("[name='province']").val(r[0]),jQuery("[name='city']").append(new Option(r[1],r[1])),jQuery("[name='city']").val(r[1]),jQuery("[name='district']").append(new Option(r[2],r[2])),jQuery("[name='district']").val(r[2]))}jQuery("[name='province']").change(function(){e.getCity(this.value)}),jQuery("[name='city']").change(function(){e.getDistrict(jQuery("[name='province']").val(),this.value)})},getCity:function(e){jQuery("[name='city']").find("option[value!='0']").remove(),jQuery("[name='district']").find("option[value!='0']").remove();var t=jQuery("[name='city']");"所在省"!=e&&o2.Actions.get("x_general_assemble_control").listCity(e,function(e){e.data.each(function(e){jQuery(t).append(new Option(e.name,e.name))})}.bind(this),null,!1)},getDistrict:function(e,t){jQuery("[name='district']").find("option[value!='0']").remove();var n=jQuery("[name='district']");o2.Actions.get("x_general_assemble_control").listDistrict(e,t,function(e){e.data.each(function(e){jQuery(n).append(new Option(e.name,e.name))})},null,!1)},loadTimeContainer:function(e){jQuery("#"+e).ymdateplugin({showTimePanel:!0})},getItemTemplate:function(e){return _self=this,{name:{text:e.name,type:"text",notEmpty:!0,value:this.customerData&&this.customerData.customername?this.customerData.customername:""},source:{type:"select",notEmpty:!0,value:this.app.lp.clue.source.value,text:e.source},telephone:{type:"text",notEmpty:!0,text:e.telephone},cellphone:{notEmpty:!0,text:e.cellphone},industry:{type:"select",text:e.industry,notEmpty:!0,value:this.app.lp.clue.industry.value},level:{type:"select",text:e.level,notEmpty:!0,value:this.app.lp.clue.level.value},address:{text:e.address,name:"address",notEmpty:!0,type:"text"},nexttime:{text:e.nexttime,name:"nexttime",notEmpty:!0,attr:{id:"nexttime"},type:"datetime"},remark:{text:e.remark,name:"remark",type:"textarea"}}},_ok:function(data,callback){var saveDataStr="";for(i in this.data)saveDataStr=saveDataStr+"'"+i+"':'"+this.data[i]+"',";saveDataStr="'{"+saveDataStr.replace(/'/g,'"')+"}'";var saveData=eval("("+saveDataStr.substring(1,saveDataStr.length-1)+")");this.app.createShade(),this.actions.saveClue(saveData,function(e){this.app.destroyShade(),this.app.notice(this.lp.saveSuccess,"success"),this.close(),this.fireEvent("reloadView",e)}.bind(this),function(e,t,n){this.app.showErrorMessage(e,t,n),this.app.destroyShade()}.bind(this))}});